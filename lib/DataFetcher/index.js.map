{"version":3,"sources":["lib/DataFetcher/index.js"],"names":["DEFAULT_TTL","DEFAULT_RETRY","DataFetcher","auth","client","storage","tabManager","ttl","timeToRetry","polling","name","actionTypes","enumMap","prefix","getReducer","getDataReducer","getTimestampReducer","dataStorageKey","timestampStorageKey","fetchFunction","options","Error","_auth","_storage","_client","_tabManager","_ttl","_timeToRetry","_polling","_fetchFunction","_dataStorageKey","_timestampStorageKey","_reducer","registerReducer","key","reducer","_promise","_timeoutId","store","subscribe","loginStatus","loggedIn","ready","status","pending","dispatch","type","init","active","isFreshLogin","timestamp","Date","now","fetchData","_startPolling","_retry","initSuccess","_clearTimeout","resetSuccess","clearTimeout","t","setTimeout","fetch","ownerId","data","fetchSuccess","fetchError","error","_fetchData","getItem","state"],"mappings":"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","file":"index.js","sourcesContent":["import RcModule from '../RcModule';\nimport { prefixEnum } from '../Enum';\nimport getDataFetcherReducer, {\n  getDefaultDataReducer,\n  getDefaultTimestampReducer,\n} from './getDataFetcherReducer';\nimport moduleStatus from '../../enums/moduleStatus';\nimport loginStatus from '../../modules/Auth/loginStatus';\nimport actionTypesBase from './actionTypesBase';\n\nconst DEFAULT_TTL = 30 * 60 * 1000;\nconst DEFAULT_RETRY = 60 * 1000;\n\nexport default class DataFetcher extends RcModule {\n  constructor({\n    auth,\n    client,\n    storage,\n    tabManager,\n    ttl = DEFAULT_TTL,\n    timeToRetry = DEFAULT_RETRY,\n    polling = false,\n    name,\n    actionTypes = prefixEnum({ enumMap: actionTypesBase, prefix: name }),\n    getReducer = getDataFetcherReducer,\n    getDataReducer = getDefaultDataReducer,\n    getTimestampReducer = getDefaultTimestampReducer,\n    dataStorageKey = `${name}Data`,\n    timestampStorageKey = `${name}Timestamp`,\n    fetchFunction,\n    ...options\n  }) {\n    if (!name) {\n      throw new Error('name must be defined');\n    }\n    if (typeof fetchFunction !== 'function') {\n      throw new Error('fetchFunction must be a asynchronous function');\n    }\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._auth = auth;\n    this._storage = storage;\n    this._client = client;\n    this._tabManager = tabManager;\n    this._ttl = ttl;\n    this._timeToRetry = timeToRetry;\n    this._polling = polling;\n    this._fetchFunction = fetchFunction;\n\n    this._dataStorageKey = dataStorageKey;\n    this._timestampStorageKey = timestampStorageKey;\n    this._reducer = getReducer(this.actionTypes);\n\n    this._storage.registerReducer({\n      key: this._dataStorageKey,\n      reducer: getDataReducer(this.actionTypes),\n    });\n    this._storage.registerReducer({\n      key: this._timestampStorageKey,\n      reducer: getTimestampReducer(this.actionTypes),\n    });\n\n    this._promise = null;\n    this._timeoutId = null;\n  }\n  initialize() {\n    this.store.subscribe(async () => {\n      if (\n        this._auth.loginStatus === loginStatus.loggedIn &&\n        this._storage.ready &&\n        this.status === moduleStatus.pending\n      ) {\n        this.store.dispatch({\n          type: this.actionTypes.init,\n        });\n        if (\n          (!this._tabManager || this._tabManager.active) &&\n          (\n            this._auth.isFreshLogin ||\n            !this.timestamp ||\n            Date.now() - this.timestamp > this._ttl\n          )\n        ) {\n          await this.fetchData();\n        } else {\n          if (this._polling) {\n            this._startPolling();\n          } else {\n            this._retry();\n          }\n        }\n        this.store.dispatch({\n          type: this.actionTypes.initSuccess,\n        });\n      } else if (\n        (!this._auth.loggedIn || !this._storage.ready) &&\n        this.ready\n      ) {\n        this._clearTimeout();\n        this._promise = null;\n        this.store.dispatch({\n          type: this.actionTypes.resetSuccess,\n        });\n      }\n    });\n  }\n\n  get data() {\n    return this._storage.getItem(this._dataStorageKey);\n  }\n\n  get timestamp() {\n    return this._storage.getItem(this._timestampStorageKey);\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatus.ready;\n  }\n\n  _clearTimeout() {\n    if (this._timeoutId) clearTimeout(this._timeoutId);\n  }\n  _startPolling(t = this.timestamp + this._ttl + 10 - Date.now()) {\n    this._clearTimeout();\n    this._timeoutId = setTimeout(() => {\n      this._timeoutId = null;\n      if (!this._tabManager || this._tabManager.active) {\n        if (!this.timestamp || Date.now() - this.timestamp > this._ttl) {\n          this.fetchData();\n        } else {\n          this._startPolling();\n        }\n      } else {\n        if (this.timestamp && Date.now() - this.timestamp < this._ttl) {\n          this._startPolling();\n        } else {\n          this._startPolling(this._timeToRetry);\n        }\n      }\n    }, t);\n  }\n  _retry(t = this._timeToRetry) {\n    this._clearTimeout();\n    this._timeoutId = setTimeout(() => {\n      this._timeoutId = null;\n      if (!this.timestamp || Date.now() - this.timestamp > this._ttl) {\n        if (!this._tabManager || this._tabManager.active) {\n          this.fetchData();\n        } else {\n          // continue retry checks in case tab becomes main tab\n          this._retry();\n        }\n      }\n    }, t);\n  }\n\n  async _fetchData() {\n    this.store.dispatch({\n      type: this.actionTypes.fetch,\n    });\n    const ownerId = this._auth.ownerId;\n    try {\n      const data = await this._fetchFunction();\n      if (this._auth.ownerId === ownerId) {\n        this.store.dispatch({\n          type: this.actionTypes.fetchSuccess,\n          data,\n          timestamp: Date.now(),\n        });\n        if (this._polling) {\n          this._startPolling();\n        }\n        this._promise = null;\n      }\n    } catch (error) {\n      if (this._auth.ownerId === ownerId) {\n        this._promise = null;\n        this.store.dispatch({\n          type: this.actionTypes.fetchError,\n          error,\n        });\n        if (this._polling) {\n          this._startPolling(this._timeToRetry);\n        } else {\n          this._retry();\n        }\n        throw error;\n      }\n    }\n  }\n  fetchData() {\n    if (!this._promise) {\n      this._promise = this._fetchData();\n    }\n    return this._promise;\n  }\n}\n"]}