{"version":3,"sources":["lib/DataMatcher/getCacheReducer.js"],"names":["getMatchRecordReducer","getDataMapReducer","getStorageReducer","actionTypes","state","type","data","sourceName","expiredKeys","matchSuccess","now","Date","entries","forEach","query","result","length","found","notFound","timestamp","cleanUp","initSuccess","newState","key","indexOf","filter","item","source","concat","map","deleteMap","newSet","dataMap","matchRecord"],"mappings":"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","file":"getCacheReducer.js","sourcesContent":["import { combineReducers } from 'redux';\nimport { getCacheKey, parseCacheKey, matchResult } from './helpers';\n\nexport function getMatchRecordReducer(actionTypes) {\n  return (state = {}, { type, data, sourceName, expiredKeys }) => {\n    switch (type) {\n      case actionTypes.matchSuccess: {\n        const now = Date.now();\n        const entries = {};\n        Object.keys(data).forEach((query) => {\n          const result = data[query].length ? matchResult.found : matchResult.notFound;\n          entries[getCacheKey(sourceName, query)] = {\n            result,\n            timestamp: now,\n          };\n        });\n        return {\n          ...state,\n          ...entries,\n        };\n      }\n      case actionTypes.cleanUp:\n      case actionTypes.initSuccess:\n        if (expiredKeys.length) {\n          const newState = {};\n          Object.keys(state).forEach((key) => {\n            if (expiredKeys.indexOf(key) === -1) {\n              newState[key] = state[key];\n            }\n          });\n          return newState;\n        }\n        return state;\n      default:\n        return state;\n    }\n  };\n}\n\nexport function getDataMapReducer(actionTypes) {\n  return (state = {}, { type, data, sourceName, expiredKeys }) => {\n    switch (type) {\n      case actionTypes.matchSuccess: {\n        const newState = { ...state };\n        Object.keys(data).forEach((query) => {\n          if (newState[query] && newState[query].length > 0) {\n            newState[query] = newState[query].filter(item => (item.source !== sourceName));\n          } else {\n            newState[query] = [];\n          }\n          if (data[query] && data[query].length > 0) {\n            newState[query] = newState[query].concat(data[query].map(item => ({\n              ...item,\n              source: sourceName,\n            })));\n          }\n        });\n        return newState;\n      }\n      case actionTypes.cleanUp:\n      case actionTypes.initSuccess:\n        if (expiredKeys.length) {\n          const deleteMap = {};\n          expiredKeys.forEach((key) => {\n            const [source, query] = parseCacheKey(key);\n            if (!deleteMap[query]) deleteMap[query] = {};\n            deleteMap[query][source] = true;\n          });\n          const newState = {};\n          Object.keys(state).forEach((query) => {\n            const newSet = state[query].filter(item => (\n              !(deleteMap[query] && deleteMap[query][item.source])\n            ));\n            if (newSet.length > 0) {\n              newState[query] = newSet;\n            }\n          });\n          return newState;\n        }\n        return state;\n      default:\n        return state;\n    }\n  };\n}\n\nexport default function getStorageReducer(actionTypes) {\n  return combineReducers({\n    dataMap: getDataMapReducer(actionTypes),\n    matchRecord: getMatchRecordReducer(actionTypes),\n  });\n}\n"]}