{"version":3,"sources":["lib/proxy/index.js"],"names":["proxify","throwOnProxy","proxyInitFunction","getProxyClient","logger","prefix","level","enums","logLevel","info","symbols","prototype","property","descriptor","trace","configurable","enumerable","value","proxyFn","args","functionPath","modulePath","transport","request","payload","type","proxyActions","execute","catch","newError","Error","originalError","error","reject","get","proxyFunction","proto","toString","initProxy","subModule","hasOwnProperty","setTransport","actions","sync","syncPromise","result","store","dispatch","Module","options","module","getState","state","id","v4","reducer","on","events","push","action","actionNumber","proxyState"],"mappings":"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","file":"index.js","sourcesContent":["import SymbolMap from 'data-types/symbol-map';\nimport Loganberry from 'loganberry';\nimport uuid from 'uuid';\nimport RcModule, { initFunction, suppressInit } from '../../lib/RcModule';\nimport proxyActions from './proxyActions';\nimport getProxyClientReducer from './getProxyClientReducer';\n\nconst logger = new Loganberry({\n  prefix: 'proxy',\n  level: Loganberry.enums.logLevel.info,\n});\n\nconst symbols = new SymbolMap([\n  'reducer',\n  'module',\n  'transport',\n  'proxyInitFunction',\n  'id',\n  'syncPromise',\n  'proxyActions',\n]);\n\nexport function proxify(prototype, property, descriptor) {\n  logger.trace(['proxify', {\n    prototype,\n    property,\n    descriptor,\n  }]);\n  const {\n    configurable,\n    enumerable,\n    value,\n  } = descriptor;\n\n  function proxyFn(...args) {\n    const functionPath = `${this.modulePath}.${property}`;\n    logger.trace(`${functionPath} proxied`);\n    return this[symbols.transport].request({\n      payload: {\n        type: this[symbols.proxyActions].execute,\n        functionPath,\n        args,\n      },\n    }).catch(error => {\n      const newError = new Error('Proxy execution timed out...');\n      newError.originalError = error;\n      return Promise.reject(newError);\n    });\n  }\n  return {\n    configurable,\n    enumerable,\n    get() {\n      if (!this[symbols.transport]) {\n        return value;\n      }\n      return proxyFn;\n    },\n  };\n}\n\nexport function throwOnProxy(prototype, property, descriptor) {\n  logger.trace(['throwOnProxy', {\n    prototype,\n    property,\n    descriptor,\n  }]);\n  const {\n    configurable,\n    enumerable,\n    value,\n  } = descriptor;\n  function proxyFunction() {\n    throw new Error(`function '${this.modulePath}.${property}' cannot be called on proxy instance`);\n  }\n  return {\n    configurable,\n    enumerable,\n    get() {\n      if (!this[symbols.transport]) {\n        return value;\n      }\n      return proxyFunction;\n    },\n  };\n}\n\nexport function proxyInitFunction(prototype, property, descriptor) {\n  const {\n    value,\n  } = descriptor;\n  if (typeof value !== 'function') {\n    throw new Error('proxyInitFunction must be a function');\n  }\n  const proto = prototype;\n  proto[symbols.proxyInitFunction] = value;\n\n  function proxyFunction() {\n    throw new Error('proxyInit function cannot be called directly');\n  }\n  proxyFunction.toString = () => value.toString();\n\n  return {\n    enumerable: true,\n    configurable: false,\n    get() {\n      return proxyFunction;\n    },\n  };\n}\n\nfunction initProxy() {\n  if (typeof this[symbols.proxyInitFunction] === 'function') {\n    this[symbols.proxyInitFunction]();\n  }\n  for (const subModule in this) {\n    if (this.hasOwnProperty(subModule) && this[subModule] instanceof RcModule) {\n      this[subModule]::initProxy();\n    }\n  }\n}\n\nfunction setTransport(transport, actions) {\n  this[symbols.transport] = transport;\n  this[symbols.proxyActions] = actions;\n  for (const subModule in this) {\n    if (this.hasOwnProperty(subModule) && this[subModule] instanceof RcModule) {\n      this[subModule]::setTransport(transport, actions);\n      this[subModule]::suppressInit();\n    }\n  }\n}\n\nfunction sync() {\n  if (!this[symbols.syncPromise]) {\n    this[symbols.syncPromise] = (async () => {\n      const result = await this[symbols.transport].request({\n        payload: {\n          type: this.actions.sync,\n        },\n      });\n      this.store.dispatch({\n        ...result,\n        type: this.actions.sync,\n      });\n      this[symbols.syncPromise] = null;\n    })();\n  }\n}\n\nexport function getProxyClient(Module) {\n  return class extends RcModule {\n    constructor(options) {\n      super({\n        ...options,\n        actions: proxyActions,\n      });\n      this[symbols.module] = new Module({\n        ...options,\n        getState: () => this.state,\n      });\n      this[symbols.id] = uuid.v4();\n\n      for (const subModule in this[symbols.module]) {\n        if (\n          this[symbols.module].hasOwnProperty(subModule) &&\n          this[symbols.module][subModule] instanceof RcModule\n        ) {\n          Object.defineProperty(this, subModule, {\n            configurable: false,\n            enumerable: true,\n            get() {\n              return this[symbols.module][subModule];\n            },\n          });\n        }\n      }\n      const {\n        transport,\n      } = options;\n      // kick the module into proxied mode\n      if (!transport) {\n        throw new Error('getProxyClient requires a transport object...');\n      }\n      this[symbols.transport] = transport;\n      this[symbols.module]::setTransport(transport, this.actions);\n\n      this[symbols.reducer] = getProxyClientReducer(this.prefix, this[symbols.module].reducer);\n    }\n    @initFunction\n    init() {\n      const transport = this[symbols.transport];\n      this[symbols.module]::initProxy();\n      transport.on(transport.events.push, async payload => {  // register push after init\n        if (payload.type === this.actions.action) {\n          logger.trace(payload);\n          if (this[symbols.syncPromise]) await this[symbols.syncPromise];\n          if (payload.actionNumber === this.proxyState.actionNumber + 1) {\n            this.store.dispatch({\n              ...payload,\n              type: this.actions.action,\n            });\n          } else {\n            this::sync();\n          }\n        }\n      });\n      this::sync();\n    }\n    get reducer() {\n      return this[symbols.reducer];\n    }\n    get state() {\n      return this.store.getState().module;\n    }\n    get proxyState() {\n      return this.store.getState();\n    }\n  };\n}\n\n"]}