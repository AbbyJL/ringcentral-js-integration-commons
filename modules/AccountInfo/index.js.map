{"version":3,"sources":["modules/AccountInfo/index.js"],"names":["AccountInfo","auth","client","storage","ttl","options","actionTypes","_auth","_storage","_client","_ttl","_storageKey","_reducer","prefix","_promise","store","subscribe","status","storageStatus","pending","dispatch","type","init","isFreshLogin","hasItem","Date","now","data","loadAccountInfo","reset","fetch","account","get","accountInfo","timestamp","setItem","fetchSuccess","actions","fetchError","error","getItem","state","serviceInfo","brand","homeCountry"],"mappings":"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","file":"index.js","sourcesContent":["import RcModule from '../../lib/RcModule';\nimport accountInfoStatus from './accountInfoStatus';\nimport accountInfoActionTypes from './accountInfoActionTypes';\nimport getAccountInfoReducer from './getAccountInfoReducer';\n\nexport default class AccountInfo extends RcModule {\n  constructor({\n    auth,\n    client,\n    storage,\n    ttl = 30 * 60 * 1000,\n    ...options,\n  }) {\n    super({\n      ...options,\n      actionTypes: accountInfoActionTypes,\n    });\n    this._auth = auth;\n    this._storage = storage;\n    this._client = client;\n    this._ttl = ttl;\n    this._storageKey = 'accountInfo';\n    this._reducer = getAccountInfoReducer(this.prefix);\n    this._promise = null;\n  }\n  initialize() {\n    this.store.subscribe(() => {\n      if (\n        this._storage.status !== this._storage.storageStatus.pending &&\n        this.status === accountInfoStatus.pending\n      ) {\n        this.store.dispatch({\n          type: this.actionTypes.init,\n        });\n        if (\n          this._auth.isFreshLogin ||\n          !this._storage.hasItem(this._storageKey) ||\n          Date.now() - this.data > this._ttl\n        ) {\n          this.loadAccountInfo();\n        }\n      } else if (\n        this._storage.status === this._storage.storageStatus.pending &&\n        this.status !== accountInfoStatus.pending\n      ) {\n        this.store.dispatch({\n          type: this.actionTypes.reset,\n        });\n      }\n    });\n  }\n\n  get data() {\n    return this._storage.getItem(this._storageKey);\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get country() {\n    return this.data.accountInfo.serviceInfo.brand.homeCountry;\n  }\n\n  get error() {\n    return this.state.error;\n  }\n\n  get accountInfoStatus() {\n    return accountInfoStatus;\n  }\n\n  async loadAccountInfo() {\n    if (!this._promise) {\n      this._promise = (async () => {\n        this.store.dispatch({\n          type: this.actionTypes.fetch,\n        });\n        try {\n          this._storage.setItem(this._storageKey, {\n            accountInfo: await this._client.account().get(),\n            timestamp: Date.now(),\n          });\n          this.store.dispatch({\n            type: this.actionTypes.fetchSuccess,\n          });\n          this._promise = null;\n        } catch (error) {\n          this.store.dispatch({\n            type: this.actions.fetchError,\n            error,\n          });\n          this._promise = null;\n          throw error;\n        }\n      })();\n    }\n    await this._promise;\n  }\n}\n"]}