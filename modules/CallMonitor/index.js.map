{"version":3,"sources":["modules/CallMonitor/index.js"],"names":["CallMonitor","accountInfo","detailedPresence","activeCalls","activityMatcher","contactMatcher","options","actionTypes","_onStateChange","_accountInfo","ready","_detailedPresence","_activeCalls","_contactMatcher","_activityMatcher","pending","store","dispatch","type","init","initSuccess","reset","resetSuccess","uniqueNumbers","_selectors","_lastProcessedNumbers","triggerMatch","sessionIds","_lastProcessedIds","_reducer","addSelector","calls","country","isoCode","callsFromPresence","callsFromActiveCalls","countryCode","map","call","activeCall","inboundLeg","find","item","sessionId","fromNumber","phoneNumber","from","toNumber","to","startTime","normalizedCalls","cache","contactCache","activityCache","fromMatches","dataMap","toMatches","activityMatches","sort","output","numberMap","addIfNotExist","number","push","forEach","addQuerySource","getQueriesFn","readyCheckFn","subscribe","state","status"],"mappings":"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","file":"index.js","sourcesContent":["import 'core-js/fn/array/find';\nimport RcModule from '../../lib/RcModule';\nimport moduleStatus from '../../enums/moduleStatus';\nimport actionTypes from './actionTypes';\nimport getCallMonitorReducer from './getCallMonitorReducer';\nimport normalizeNumber from '../../lib/normalizeNumber';\nimport {\n  sortByStartTime,\n} from '../../lib/callLogHelpers';\nimport ensureExist from '../../lib/ensureExist';\n\n\nexport default class CallMonitor extends RcModule {\n  constructor({\n    accountInfo,\n    detailedPresence,\n    activeCalls,\n    activityMatcher,\n    contactMatcher,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._accountInfo = this::ensureExist(accountInfo, 'accountInfo');\n    this._detailedPresence = this::ensureExist(detailedPresence, 'detailedPresence');\n    this._activeCalls = this::ensureExist(activeCalls, 'activeCalls');\n    this._contactMatcher = contactMatcher;\n    this._activityMatcher = activityMatcher;\n    this._reducer = getCallMonitorReducer(this.actionTypes);\n    this.addSelector('normalizedCalls',\n      () => this._detailedPresence.calls,\n      () => this._activeCalls.calls,\n      () => this._accountInfo.country.isoCode,\n      (callsFromPresence, callsFromActiveCalls, countryCode) => (\n        callsFromPresence.map((call) => {\n          const activeCall = call.inboundLeg && callsFromActiveCalls.find(item => item.sessionId === call.inboundLeg.sessionId);\n\n          // use account countryCode to normalize number due to API issues [RCINT-3419]\n          const fromNumber = normalizeNumber({\n            phoneNumber: call.from && call.from.phoneNumber,\n            countryCode,\n          });\n          const toNumber = normalizeNumber({\n            phoneNumber: call.to && call.to.phoneNumber,\n            countryCode,\n          });\n\n          return {\n            ...call,\n            from: {\n              ...((activeCall && activeCall.to) || {}),\n              phoneNumber: fromNumber,\n            },\n            to: {\n              ...((activeCall && activeCall.from) || {}),\n              phoneNumber: toNumber,\n            },\n            startTime: (activeCall && activeCall.startTime) || call.startTime,\n          };\n        })\n      ),\n    );\n    this.addSelector('calls',\n      this._selectors.normalizedCalls,\n      () => (this._contactMatcher && this._contactMatcher.ready ?\n        this._contactMatcher.cache :\n        null),\n      () => (this._activityMatcher && this._activityMatcher.ready ?\n        this._activityMatcher.cache :\n        null),\n      (normalizedCalls, contactCache, activityCache) => (\n        normalizedCalls.map((call) => {\n          const fromNumber = call.from && call.from.phoneNumber;\n          const toNumber = call.to && call.to.phoneNumber;\n          return {\n            ...call,\n            fromMatches: (fromNumber && contactCache && contactCache.dataMap[fromNumber]) || [],\n            toMatches: (toNumber && contactCache && contactCache.dataMap[toNumber]) || [],\n            activityMatches: (activityCache && activityCache.dataMap[call.sessionId]) || [],\n          };\n        }).sort(sortByStartTime)\n      )\n    );\n\n    this.addSelector('uniqueNumbers',\n      this._selectors.normalizedCalls,\n      (normalizedCalls) => {\n        const output = [];\n        const numberMap = {};\n        function addIfNotExist(number) {\n          if (!numberMap[number]) {\n            output.push(number);\n            numberMap[number] = true;\n          }\n        }\n        normalizedCalls.forEach((call) => {\n          if (call.from && call.from.phoneNumber) {\n            addIfNotExist(call.from.phoneNumber);\n          }\n          if (call.to && call.to.phoneNumber) {\n            addIfNotExist(call.to.phoneNumber);\n          }\n        });\n        return output;\n      }\n    );\n\n    if (this._contactMatcher) {\n      this._contactMatcher.addQuerySource({\n        getQueriesFn: this._selectors.uniqueNumbers,\n        readyCheckFn: () => (\n          this._accountInfo.ready &&\n          this._activeCalls.ready &&\n          this._detailedPresence.ready\n        ),\n      });\n    }\n    this.addSelector('sessionIds',\n      () => this._detailedPresence.calls,\n      calls => calls.map(call => call.sessionId)\n    );\n    if (this._activityMatcher) {\n      this._activityMatcher.addQuerySource({\n        getQueriesFn: this._selectors.sessionIds,\n        readyCheckFn: () => this._detailedPresence.ready,\n      });\n    }\n\n    this._lastProcessedNumbers = null;\n  }\n\n  _onStateChange = async () => {\n    if (\n      this._accountInfo.ready &&\n      this._detailedPresence.ready &&\n      this._activeCalls.ready &&\n      (!this._contactMatcher || this._contactMatcher.ready) &&\n      (!this._activityMatcher || this._activityMatcher.ready) &&\n      this.pending\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.init,\n      });\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n    } else if (\n      (\n        !this._accountInfo.ready ||\n        !this._detailedPresence.ready ||\n        !this._activeCalls.ready ||\n        (this._contactMatcher && !this._contactMatcher.ready) ||\n        (this._activityMatcher && !this._activityMatcher.ready)\n      ) &&\n      this.ready\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.reset,\n      });\n      this.store.dispatch({\n        type: this.actionTypes.resetSuccess,\n      });\n    } else if (\n      this.ready\n    ) {\n      const uniqueNumbers = this._selectors.uniqueNumbers();\n      if (this._lastProcessedNumbers !== uniqueNumbers) {\n        this._lastProcessedNumbers = uniqueNumbers;\n        if (this._contactMatcher && this._contactMatcher.ready) {\n          this._contactMatcher.triggerMatch();\n        }\n      }\n      const sessionIds = this._selectors.sessionIds();\n      if (this._lastProcessedIds !== sessionIds) {\n        this._lastProcessedIds = sessionIds;\n        if (this._activityMatcher && this._activityMatcher.ready) {\n          this._activityMatcher.triggerMatch();\n        }\n      }\n    }\n  }\n  initialize() {\n    this.store.subscribe(this._onStateChange);\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatus.ready;\n  }\n\n  get pending() {\n    return this.state.status === moduleStatus.pending;\n  }\n\n  get calls() {\n    return this._selectors.calls();\n  }\n}\n"]}