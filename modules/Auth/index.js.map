{"version":3,"sources":["modules/Auth/index.js"],"names":["DEFAULT_PROXY_RETRY","getDefaultRedirectUri","window","resolve","location","href","getDefaultProxyUri","Auth","deps","dep","optional","client","alert","redirectUri","proxyUri","brand","locale","tabManager","environment","defaultProxyRetry","options","actionTypes","_createProxyFrame","onLogin","_proxyFrame","document","createElement","src","style","display","setAttribute","join","body","appendChild","_callbackHandler","origin","data","callbackUri","proxyLoaded","fromLocalStorage","_tabManager","active","code","login","message","accessDenied","internalError","_alert","danger","payload","clearTimeout","_retryTimeoutId","store","dispatch","type","addEventListener","setTimeout","_retrySetupProxyFrame","_defaultProxyRetry","_client","_brand","_locale","_redirectUri","_proxyUri","_environment","_reducer","_beforeLogoutHandlers","_afterLoggedInHandlers","_proxyFrameLoaded","_unbindEvents","_lastEnvironmentCounter","platform","service","onRequestError","apiResponse","Error","logout","onLoginSuccess","loginSuccess","token","auth","handlers","handler","onLoginError","error","loginError","onLogoutSuccess","logoutSuccess","onLogoutError","_cache","clean","logoutError","onRefreshSuccess","refreshSuccess","onRefreshError","refreshTokenValid","refreshError","access_token","sessionExpired","ttl","addListener","events","requestError","removeListener","loggedIn","subscribe","status","pending","ready","init","_bindEvents","initSuccess","loginStatus","notLoggedIn","send","event","name","args","tabSync","changeCounter","username","password","extension","remember","state","brandId","prompt","force","loginUrl","beforeLogout","result","cancelLogout","reject","beforeLogoutError","add","removeBeforeLogoutHandler","remove","_transport","proxySetup","proxyRetry","_destroyProxyFrame","removeChild","removeEventListener","proxyCleared","extendedQuery","qs","stringify","localeId","currentLocale","ui_options","contentWindow","postMessage","oAuthUri","getLoginUrl","id","btoa","Date","now","ownerId","endpointId","accessToken","freshLogin","proxyRetryCount"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;;;AACA;;;;AACA;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA,IAAMA,sBAAsB,IAA5B;;AAEA,SAASC,qBAAT,GAAiC;AAC/B,MAAI,OAAOC,MAAP,KAAkB,WAAtB,EAAmC;AACjC,WAAO,cAAIC,OAAJ,CAAYD,OAAOE,QAAP,CAAgBC,IAA5B,EAAkC,iBAAlC,CAAP;AACD;AACD,SAAO,IAAP;AACD;;AAED,SAASC,kBAAT,GAA8B;AAC5B,MAAI,OAAOJ,MAAP,KAAkB,WAAtB,EAAmC;AACjC,WAAO,cAAIC,OAAJ,CAAYD,OAAOE,QAAP,CAAgBC,IAA5B,EAAkC,cAAlC,CAAP;AACD;AACD,SAAO,IAAP;AACD;;AAED;;;;IAeqBE,I,WAXpB,gBAAO;AACNC,QAAM,CACJ,QADI,EAEJ,OAFI,EAGJ,OAHI,EAIJ,QAJI,EAKJ,EAAEC,KAAK,YAAP,EAAqBC,UAAU,IAA/B,EALI,EAMJ,EAAED,KAAK,aAAP,EAAsBC,UAAU,IAAhC,EANI,EAOJ,EAAED,KAAK,aAAP,EAAsBC,UAAU,IAAhC,EAPI;AADA,CAAP,C;;;AAYC;;;;;;;;;;;;;AAaA,kBAWQ;AAAA;;AAAA,mFAAJ,EAAI;;AAAA,QAVNC,MAUM,QAVNA,MAUM;AAAA,QATNC,KASM,QATNA,KASM;AAAA,gCARNC,WAQM;AAAA,QARNA,WAQM,oCARQZ,uBAQR;AAAA,6BAPNa,QAOM;AAAA,QAPNA,QAOM,iCAPKR,oBAOL;AAAA,QANNS,KAMM,QANNA,KAMM;AAAA,QALNC,MAKM,QALNA,MAKM;AAAA,QAJNC,UAIM,QAJNA,UAIM;AAAA,QAHNC,WAGM,QAHNA,WAGM;AAAA,qCAFNC,iBAEM;AAAA,QAFNA,iBAEM,yCAFcnB,mBAEd;AAAA,QADHoB,OACG;AAAA;;AAAA,6JAEDA,OAFC;AAGJC;AAHI;;AAAA,UA2VRC,iBA3VQ,GA2VY,UAACC,OAAD,EAAa;AAC/B,YAAKC,WAAL,GAAmBC,SAASC,aAAT,CAAuB,QAAvB,CAAnB;AACA,YAAKF,WAAL,CAAiBG,GAAjB,GAAuB,MAAKb,QAA5B;AACA,YAAKU,WAAL,CAAiBI,KAAjB,CAAuBC,OAAvB,GAAiC,MAAjC;AACA,YAAKL,WAAL,CAAiBM,YAAjB,CAA8B,SAA9B,EAAyC,CACvC,eADuC,EAEvC,cAFuC,EAGvC,mBAHuC,EAIvC,aAJuC,EAKvCC,IALuC,CAKlC,GALkC,CAAzC;;AAOAN,eAASO,IAAT,CAAcC,WAAd,CAA0B,MAAKT,WAA/B;AACA,YAAKU,gBAAL;AAAA,+EAAwB;AAAA,cAASC,MAAT,SAASA,MAAT;AAAA,cAAiBC,IAAjB,SAAiBA,IAAjB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,uBAElBA,IAFkB;AAAA;AAAA;AAAA;;AAIlBC,6BAJkB,GAOhBD,IAPgB,CAIlBC,WAJkB,EAKlBC,WALkB,GAOhBF,IAPgB,CAKlBE,WALkB,EAMlBC,gBANkB,GAOhBH,IAPgB,CAMlBG,gBANkB;;AAAA,wBASlBF,gBAEEE,qBAAqB,IAArB,IACC,CAAC,MAAKC,WAAN,IAAqB,MAAKA,WAAL,CAAiBC,MAHzC,CATkB;AAAA;AAAA;AAAA;;AAAA;AAgBVC,sBAhBU,GAgBH,gCAAiBL,WAAjB,CAhBG;;AAAA,uBAiBZK,IAjBY;AAAA;AAAA;AAAA;;AAAA;AAAA,yBAkBR,MAAKC,KAAL,CAAW;AACfD,8BADe;AAEf7B,iCAAa,MAAKA;AAFH,mBAAX,CAlBQ;;AAAA;AAsBd,sBAAI,OAAOU,OAAP,KAAmB,UAAvB,EAAmC;AACjCA;AACD;;AAxBa;AAAA;AAAA;;AAAA;AAAA;AAAA;AA2BZqB,yBA3BY;AAAA,gCA4BR,YAAMA,OA5BE;AAAA,kDA6BT,iBA7BS,wBA8BT,qBA9BS,wBA+BT,eA/BS,wBAgCT,2BAhCS,wBAiCT,eAjCS,wBAoCT,cApCS,wBAqCT,yBArCS;AAAA;;AAAA;AAkCZA,4BAAU,uBAAaC,YAAvB;AAlCY;;AAAA;AAuCZD,4BAAU,uBAAaE,aAAvB;AAvCY;;AAAA;;AA2ChB,wBAAKC,MAAL,CAAYC,MAAZ,CAAmB;AACjBJ,oCADiB;AAEjBK;AAFiB,mBAAnB;;AA3CgB;AAAA;AAAA;;AAAA;AAgDb,sBAAIX,WAAJ,EAAiB;AACtBY,iCAAa,MAAKC,eAAlB;AACA,0BAAKA,eAAL,GAAuB,IAAvB;AACA,0BAAKC,KAAL,CAAWC,QAAX,CAAoB;AAClBC,4BAAM,MAAKjC,WAAL,CAAiBiB;AADL,qBAApB;AAGD;;AAtDmB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAAxB;;AAAA;AAAA;AAAA;AAAA;AAyDApC,aAAOqD,gBAAP,CAAwB,SAAxB,EAAmC,MAAKrB,gBAAxC;AACA,YAAKiB,eAAL,GAAuBK,WAAW,YAAM;AACtC,cAAKC,qBAAL,CAA2BlC,OAA3B;AACD,OAFsB,EAEpB,MAAKmC,kBAFe,CAAvB;AAGD,KApaO;;AAKN,UAAKC,OAAL,GAAe,2BAAYhD,MAAZ,EAAoB,QAApB,CAAf;AACA,UAAKoC,MAAL,GAAc,2BAAYnC,KAAZ,EAAmB,OAAnB,CAAd;AACA,UAAKgD,MAAL,GAAc,2BAAY7C,KAAZ,EAAmB,OAAnB,CAAd;AACA,UAAK8C,OAAL,GAAe,2BAAY7C,MAAZ,EAAoB,QAApB,CAAf;AACA,UAAK8C,YAAL,GAAoBjD,WAApB;AACA,UAAKkD,SAAL,GAAiBjD,QAAjB;AACA,UAAK0B,WAAL,GAAmBvB,UAAnB;AACA,UAAK+C,YAAL,GAAoB9C,WAApB;AACA,UAAKwC,kBAAL,GAA0BvC,iBAA1B;AACA,UAAK8C,QAAL,GAAgB,8BAAe,MAAK5C,WAApB,CAAhB;AACA,UAAK6C,qBAAL,GAA6B,mBAA7B;AACA,UAAKC,sBAAL,GAA8B,mBAA9B;AACA,UAAK3C,WAAL,GAAmB,IAAnB;AACA,UAAK4C,iBAAL,GAAyB,KAAzB;AACA,UAAKC,aAAL,GAAqB,IAArB;AACA,UAAKC,uBAAL,GAA+B,CAA/B;AApBM;AAqBP;;;;kCACa;AAAA;;AACZ,UAAI,KAAKD,aAAT,EAAwB,KAAKA,aAAL;;AAExB,UAAME,WAAW,KAAKZ,OAAL,CAAaa,OAAb,CAAqBD,QAArB,EAAjB;AACA,UAAM5D,SAAS,KAAKgD,OAAL,CAAaa,OAAb,CAAqBb,OAApC;AACA,UAAMc,iBAAiB,SAAjBA,cAAiB,CAACC,WAAD,EAAiB;AACtC,YACEA,uBAAuBC,KAAvB,IACAD,YAAY9B,OAAZ,KAAwB,eAF1B,EAGE;AACA,iBAAKgC,MAAL;AACD;AACF,OAPD;;AASA,UAAMC;AAAA,+EAAiB;AAAA;;AAAA;AAAA;AAAA;AAAA;AACrB,yBAAKzB,KAAL,CAAWC,QAAX,CAAoB;AAClBC,0BAAM,OAAKjC,WAAL,CAAiByD,YADL;AAElBC,2BAAOR,SAASS,IAAT,GAAgB5C,IAAhB;AAFW,mBAApB;AAIM6C,0BALe,8CAKA,OAAKd,sBALL;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAMVe,mCANU;AAAA;AAAA,mCAOb,2DAAC;AAAA;AAAA;AAAA;AAAA;AAAA,wEAAYA,SAAZ;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,6BAAD,IAPa;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,yDAMCD,QAND;;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAAjB;;AAAA;AAAA;AAAA;AAAA,SAAN;AAUA,UAAME,eAAe,SAAfA,YAAe,CAACC,KAAD,EAAW;AAC9B,eAAKhC,KAAL,CAAWC,QAAX,CAAoB;AAClBC,gBAAM,OAAKjC,WAAL,CAAiBgE,UADL;AAElBD;AAFkB,SAApB;AAIA,YAAIA,KAAJ,EAAW;AACT,iBAAKrC,MAAL,CAAYC,MAAZ,CAAmB;AACjBJ,qBAAS,uBAAayC,UADL;AAEjBpC,qBAASmC;AAFQ,WAAnB;AAID;AACF,OAXD;AAYA,UAAME,kBAAkB,SAAlBA,eAAkB,GAAM;AAC5B,eAAKlC,KAAL,CAAWC,QAAX,CAAoB;AAClBC,gBAAM,OAAKjC,WAAL,CAAiBkE;AADL,SAApB;AAGD,OAJD;AAKA,UAAMC,gBAAgB,SAAhBA,aAAgB,CAACJ,KAAD,EAAW;AAC/Bb,iBAASkB,MAAT,CAAgBC,KAAhB;AACA,eAAKtC,KAAL,CAAWC,QAAX,CAAoB;AAClBC,gBAAM,OAAKjC,WAAL,CAAiBsE,WADL;AAElBP;AAFkB,SAApB;AAIA,YAAIA,KAAJ,EAAW;AACT,iBAAKrC,MAAL,CAAYC,MAAZ,CAAmB;AACjBJ,qBAAS,uBAAa+C,WADL;AAEjB1C,qBAASmC;AAFQ,WAAnB;AAID;AACF,OAZD;AAaA,UAAMQ,mBAAmB,SAAnBA,gBAAmB,GAAM;AAC7B,eAAKxC,KAAL,CAAWC,QAAX,CAAoB;AAClBC,gBAAM,OAAKjC,WAAL,CAAiBwE,cADL;AAElBd,iBAAOR,SAASS,IAAT,GAAgB5C,IAAhB;AAFW,SAApB;AAID,OALD;AAMA,UAAM0D,iBAAiB,SAAjBA,cAAiB,CAACV,KAAD,EAAW;AAChC;;AAEA,YAAMW,oBAAoBX,MAAMxC,OAAN,KAAkB,iBAAlB,IAAuC2B,SAASS,IAAT,GAAgBe,iBAAhB,EAAjE;AACA,eAAK3C,KAAL,CAAWC,QAAX,CAAoB;AAClBC,gBAAM,OAAKjC,WAAL,CAAiB2E,YADL;AAElBZ,sBAFkB;AAGlBW;AAHkB,SAApB;AAKA,YAAI,CAACA,iBAAD,IAAsB,OAAKpC,OAAL,CAAaa,OAAb,CAAqBD,QAArB,GAAgCS,IAAhC,GAAuC5C,IAAvC,GAA8C6D,YAA9C,KAA+D,EAAzF,EAA6F;AAC3F,iBAAKlD,MAAL,CAAYC,MAAZ,CAAmB;AACjBJ,qBAAS,uBAAasD,cADL;AAEjBjD,qBAASmC,KAFQ;AAGjBe,iBAAK;AAHY,WAAnB;AAKA;AACA5B,mBAASkB,MAAT,CAAgBC,KAAhB;AACD;AACF,OAlBD;AAmBAnB,eAAS6B,WAAT,CAAqB7B,SAAS8B,MAAT,CAAgBvB,YAArC,EAAmDD,cAAnD;AACAN,eAAS6B,WAAT,CAAqB7B,SAAS8B,MAAT,CAAgBhB,UAArC,EAAiDF,YAAjD;AACAZ,eAAS6B,WAAT,CAAqB7B,SAAS8B,MAAT,CAAgBd,aAArC,EAAoDD,eAApD;AACAf,eAAS6B,WAAT,CAAqB7B,SAAS8B,MAAT,CAAgBV,WAArC,EAAkDH,aAAlD;AACAjB,eAAS6B,WAAT,CAAqB7B,SAAS8B,MAAT,CAAgBR,cAArC,EAAqDD,gBAArD;AACArB,eAAS6B,WAAT,CAAqB7B,SAAS8B,MAAT,CAAgBL,YAArC,EAAmDF,cAAnD;AACAnF,aAAOyF,WAAP,CAAmBzF,OAAO0F,MAAP,CAAcC,YAAjC,EAA+C7B,cAA/C;AACA,WAAKJ,aAAL,GAAqB,YAAM;AACzBE,iBAASgC,cAAT,CAAwBhC,SAAS8B,MAAT,CAAgBvB,YAAxC,EAAsDD,cAAtD;AACAN,iBAASgC,cAAT,CAAwBhC,SAAS8B,MAAT,CAAgBhB,UAAxC,EAAoDF,YAApD;AACAZ,iBAASgC,cAAT,CAAwBhC,SAAS8B,MAAT,CAAgBd,aAAxC,EAAuDD,eAAvD;AACAf,iBAASgC,cAAT,CAAwBhC,SAAS8B,MAAT,CAAgBV,WAAxC,EAAqDH,aAArD;AACAjB,iBAASgC,cAAT,CAAwBhC,SAAS8B,MAAT,CAAgBR,cAAxC,EAAwDD,gBAAxD;AACArB,iBAASgC,cAAT,CAAwBhC,SAAS8B,MAAT,CAAgBL,YAAxC,EAAsDF,cAAtD;AACAnF,eAAO4F,cAAP,CAAsB5F,OAAO0F,MAAP,CAAcC,YAApC,EAAkD7B,cAAlD;AACD,OARD;AASD;;;iCACY;AAAA;;AACX,UAAI+B,iBAAJ;AACA,WAAKpD,KAAL,CAAWqD,SAAX,4DAAqB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,sBAEjB,OAAKC,MAAL,KAAgB,yBAAeC,OAA/B,IACA,OAAK9C,OAAL,CAAa+C,KADb,KAEC,CAAC,OAAKpE,WAAN,IAAqB,OAAKA,WAAL,CAAiBoE,KAFvC,MAGC,CAAC,OAAK5C,YAAN,IAAsB,OAAKA,YAAL,CAAkB4C,KAHzC,CAFiB;AAAA;AAAA;AAAA;;AAOjB,uBAAKxD,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,OAAKjC,WAAL,CAAiBwF;AADL,iBAApB;AAGMtC,wBAVW,GAUA,OAAKZ,OAAL,CAAaa,OAAb,CAAqBD,QAArB,EAVA;AAAA;AAAA,uBAWAA,SAASiC,QAAT,EAXA;;AAAA;AAWjBA,wBAXiB;;AAYjB,uBAAKM,WAAL;AACA,uBAAK1D,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,OAAKjC,WAAL,CAAiB0F,WADL;AAElBP,oCAFkB;AAGlBzB,yBAAOyB,WAAWjC,SAASS,IAAT,GAAgB5C,IAAhB,EAAX,GAAoC;AAHzB,iBAApB;;AAbiB;AAmBnB,oBACG,OAAKI,WAAL,IAAoB,OAAKA,WAAL,CAAiBoE,KAAtC,IACA,OAAKA,KAFP,EAGE;AACA,sBACGJ,YAAY,OAAKQ,WAAL,KAAqB,sBAAYC,WAA9C,IACC,CAACT,QAAD,IAAa,OAAKQ,WAAL,KAAqB,sBAAYR,QAFjD,EAGE;AACAA,+BAAW,CAACA,QAAZ;AACA,2BAAKhE,WAAL,CAAiB0E,IAAjB,CAAsB,mBAAtB,EAA2CV,QAA3C;AACD,mBAND,MAMO,IACL,OAAKhE,WAAL,CAAiB2E,KAAjB,IACA,OAAK3E,WAAL,CAAiB2E,KAAjB,CAAuBC,IAAvB,KAAgC,mBADhC,IAEA,OAAK5E,WAAL,CAAiB2E,KAAjB,CAAuBE,IAAvB,CAA4B,CAA5B,MAAmCb,QAH9B,EAIL;AACA;AACAA,+BAAW,OAAKhE,WAAL,CAAiB2E,KAAjB,CAAuBE,IAAvB,CAA4B,CAA5B,CAAX;AACA,2BAAKjE,KAAL,CAAWC,QAAX,CAAoB;AAClBC,4BAAM,OAAKjC,WAAL,CAAiBiG,OADL;AAElBd,wCAFkB;AAGlBzB,6BAAOyB,WAAW,OAAK7C,OAAL,CAAaa,OAAb,CAAqBD,QAArB,GAAgCS,IAAhC,GAAuC5C,IAAvC,EAAX,GAA2D;AAHhD,qBAApB;AAKD;AACF;AACD,oBACE,OAAKwE,KAAL,IACA,OAAK5C,YADL,IAEA,OAAKA,YAAL,CAAkBuD,aAAlB,KAAoC,OAAKjD,uBAH3C,EAIE;AACA,yBAAKA,uBAAL,GAA+B,OAAKN,YAAL,CAAkBuD,aAAjD;AACA,yBAAKT,WAAL;AACD;;AAlDkB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAArB;AAoDD;;;;;YA+DCU,Q,SAAAA,Q;YAAUC,Q,SAAAA,Q;YAAUC,S,SAAAA,S;YAAWC,Q,SAAAA,Q;YAAUjF,I,SAAAA,I;YAAM7B,W,SAAAA,W;;;;;AAE/C,qBAAKuC,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,KAAKjC,WAAL,CAAiBsB;AADL,iBAApB;kDAGO,KAAKgB,OAAL,CAAaa,OAAb,CAAqBD,QAArB,GAAgC5B,KAAhC,CAAsC;AAC3C6E,oCAD2C;AAE3CC,oCAF2C;AAG3CC,sCAH2C;AAI3CC,oCAJ2C;AAK3CjF,4BAL2C;AAM3C7B;AAN2C,iBAAtC,C;;;;;;;;;;;;;;;;AAST;;;;;;;;;;;uCAUG;AAAA,UADDA,WACC,SADDA,WACC;AAAA,UADY+G,KACZ,SADYA,KACZ;AAAA,UADmBC,OACnB,SADmBA,OACnB;AAAA,UAD4BhG,OAC5B,SAD4BA,OAC5B;AAAA,UADqCiG,MACrC,SADqCA,MACrC;AAAA,UAD6CC,KAC7C,SAD6CA,KAC7C;;AACD,kBAAU,KAAKpE,OAAL,CAAaa,OAAb,CAAqBD,QAArB,GAAgCyD,QAAhC,CAAyC;AACjDnH,gCADiD;AAEjD+G,oBAFiD;AAGjDC,wBAHiD;AAIjDhG,wBAJiD;AAKjDiG;AALiD,OAAzC,CAAV,IAMKC,QAAQ,QAAR,GAAmB,EANxB;AAOD;;AAED;;;;;;;;;;;;;;;;;;AAOE,qBAAK3E,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,KAAKjC,WAAL,CAAiB4G;AADL,iBAApB;AAGMhD,wB,8CAAe,KAAKf,qB;;;;;;;;;;;;AAEbgB,iC;;iCACY,2DAAC;AAAA;AAAA;AAAA;AAAA;AAAA,sEAAYA,SAAZ;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,2BAAD,I;;;AAAfgD,gC;;+BACFA,M;;;;;AACF,iCAAK9E,KAAL,CAAWC,QAAX,CAAoB;AAClBC,kCAAM,OAAKjC,WAAL,CAAiB8G;AADL,2BAApB;;+BAGO,kBAAQC,MAAR,CAAeF,MAAf;;;;;;;;;;wDANWjD,Q;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAUtB,qBAAKlC,MAAL,CAAYC,MAAZ,CAAmB;AACjBJ,2BAAS,uBAAayF,iBADL;AAEjBpF;AAFiB,iBAAnB;;;AAKF,qBAAKG,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,KAAKjC,WAAL,CAAiBuD;AADL,iBAApB;kDAGO,KAAKjB,OAAL,CAAaa,OAAb,CAAqBD,QAArB,GAAgCK,MAAhC,E;;;;;;;;;;;;;;;;;AAGT;;;;;;;;2CAKuBM,O,EAAS;AAAA;;AAC9B,WAAKhB,qBAAL,CAA2BoE,GAA3B,CAA+BpD,OAA/B;AACA,aAAO,YAAM;AACX,eAAKqD,yBAAL,CAA+BrD,OAA/B;AACD,OAFD;AAGD;;AAED;;;;;;;8CAI0BA,O,EAAS;AACjC,WAAKhB,qBAAL,CAA2BsE,MAA3B,CAAkCtD,OAAlC;AACD;;;4CAEuBA,O,EAAS;AAAA;;AAC/B,WAAKf,sBAAL,CAA4BmE,GAA5B,CAAgCpD,OAAhC;AACA,aAAO,YAAM;AACX,eAAKf,sBAAL,CAA4BqE,MAA5B,CAAmCtD,OAAnC;AACD,OAFD;AAGD;;;;;;;;;;uBAOO,KAAKvB,OAAL,CAAaa,OAAb,CAAqBD,QAArB,GAAgCiC,QAAhC,E;;;mDACC,KAAKoB,KAAL,CAAWZ,WAAX,KAA2B,sBAAYR,Q;;;;;;;;;;;;;;;;;;;AAsFhD;;;;;;;gGAMsBjF,O;;;;;AACpB,oBACE,CAAC,KAAKkH,UAAN,IAAoB;AACpB,uBAAOvI,MAAP,KAAkB,WADlB,IAEA,OAAOuB,QAAP,KAAoB,WAFpB,IAGA,KAAKsC,SAHL,IAIA,KAAKA,SAAL,KAAmB,EAJnB,IAKA,CAAC,KAAKvC,WANR,EAOE;AACA,uBAAK4B,KAAL,CAAWC,QAAX,CAAoB;AAClBC,0BAAM,KAAKjC,WAAL,CAAiBqH;AADL,mBAApB;AAGA,uBAAKpH,iBAAL,CAAuBC,OAAvB;AACD;;;;;;;;;;;;;;;;;;0CAEmBA,O,EAAS;AAC7B,WAAK4B,eAAL,GAAuB,IAAvB;AACA,UAAI,CAAC,KAAKb,WAAV,EAAuB;AACrB,aAAKc,KAAL,CAAWC,QAAX,CAAoB;AAClBC,gBAAM,KAAKjC,WAAL,CAAiBsH;AADL,SAApB;AAGA,aAAKC,kBAAL;AACA,aAAKtH,iBAAL,CAAuBC,OAAvB;AACD;AACF;;;yCACoB;AACnBE,eAASO,IAAT,CAAc6G,WAAd,CAA0B,KAAKrH,WAA/B;AACA,WAAKA,WAAL,GAAmB,IAAnB;AACAtB,aAAO4I,mBAAP,CAA2B,SAA3B,EAAsC,KAAK5G,gBAA3C;AACA,WAAKA,gBAAL,GAAwB,IAAxB;AACD;;;;;;;;;AAGC,oBAAI,KAAKV,WAAT,EAAsB;AACpB,sBAAI,KAAK2B,eAAT,EAA0B;AACxBD,iCAAa,KAAKC,eAAlB;AACA,yBAAKA,eAAL,GAAuB,IAAvB;AACD;AACD,uBAAKyF,kBAAL;AACA,uBAAKxF,KAAL,CAAWC,QAAX,CAAoB;AAClBC,0BAAM,KAAKjC,WAAL,CAAiB0H;AADL,mBAApB;AAGD;;;;;;;;;;;;;;;;;;oCAIa;AACd,UAAI,KAAKzG,WAAT,EAAsB;AACpB,YAAM0G,gBAAgBC,GAAGC,SAAH,CAAa;AACjCnB,iBAAO,IAD0B;AAEjCoB,oBAAU,KAAKtF,OAAL,CAAauF,aAFU;AAGjCC,sBAAY;AAHqB,SAAb,CAAtB;AAKA,aAAK7H,WAAL,CAAiB8H,aAAjB,CAA+BC,WAA/B,CAA2C;AACzCC,oBAAa,KAAKC,WAAL,CAAiB;AAC5B5I,yBAAa,KAAKA,WADU;AAE5BgH,qBAAS,KAAKjE,MAAL,CAAY8F,EAFO;AAG5B9B,mBAAO+B,KAAKC,KAAKC,GAAL,EAAL,CAHqB;AAI5BhI,qBAAS;AAJmB,WAAjB,CAAb,SAKMmH;AANmC,SAA3C,EAOG,GAPH;AAQD;AACF;;;wBA3TiB;AAChB,aAAO,cAAI7I,OAAJ,CAAYD,OAAOE,QAAP,CAAgBC,IAA5B,EAAkC,KAAKyD,YAAvC,CAAP;AACD;;;wBAEc;AACb,aAAO,KAAKC,SAAZ;AACD;;;wBAEW;AACV,aAAO,KAAK6D,KAAL,CAAW7C,KAAlB;AACD;;;wBAEa;AACZ,aAAO,KAAKA,KAAL,CAAW+E,OAAlB;AACD;;;wBAEgB;AACf,aAAO,KAAK/E,KAAL,CAAWgF,UAAlB;AACD;;;wBAEiB;AAChB,aAAO,KAAKhF,KAAL,CAAWiF,WAAlB;AACD;;;wBAEY;AACX,aAAO,KAAKpC,KAAL,CAAWlB,MAAlB;AACD;;;wBAEW;AACV,aAAO,KAAKkB,KAAL,CAAWlB,MAAX,KAAsB,yBAAeE,KAA5C;AACD;;;wBAEiB;AAChB,aAAO,KAAKgB,KAAL,CAAWZ,WAAlB;AACD;;;wBAEkB;AACjB,aAAO,KAAKY,KAAL,CAAWqC,UAAlB;AACD;;;wBAEiB;AAChB,aAAO,KAAKrC,KAAL,CAAWtF,WAAlB;AACD;;;wBAEqB;AACpB,aAAO,KAAKsF,KAAL,CAAWsC,eAAlB;AACD;;AAED;;;;;;;;;;;;;;wBAoHe;AACb,aAAO,KAAKtC,KAAL,CAAWZ,WAAX,KAA2B,sBAAYR,QAAvC,IACL,KAAKoB,KAAL,CAAWZ,WAAX,KAA2B,sBAAYiB,YADzC;AAED;;;wBAEiB;AAChB,aAAO,KAAKL,KAAL,CAAWZ,WAAX,KAA2B,sBAAYC,WAA9C;AACD;;;;kBAlXkB1G,I","file":"index.js","sourcesContent":["import url from 'url';\nimport RcModule from '../../lib/RcModule';\nimport { Module } from '../../lib/di';\nimport getAuthReducer from './getAuthReducer';\nimport actionTypes from './actionTypes';\nimport loginStatus from './loginStatus';\nimport authMessages from './authMessages';\nimport moduleStatuses from '../../enums/moduleStatuses';\nimport parseCallbackUri from '../../lib/parseCallbackUri';\nimport ensureExist from '../../lib/ensureExist';\nimport proxify from '../../lib/proxy/proxify';\n\nconst DEFAULT_PROXY_RETRY = 5000;\n\nfunction getDefaultRedirectUri() {\n  if (typeof window !== 'undefined') {\n    return url.resolve(window.location.href, './redirect.html');\n  }\n  return null;\n}\n\nfunction getDefaultProxyUri() {\n  if (typeof window !== 'undefined') {\n    return url.resolve(window.location.href, './proxy.html');\n  }\n  return null;\n}\n\n/**\n * @class\n * @description Authentication module\n */\n@Module({\n  deps: [\n    'Client',\n    'Alert',\n    'Brand',\n    'Locale',\n    { dep: 'TabManager', optional: true },\n    { dep: 'Environment', optional: true },\n    { dep: 'AuthOptions', optional: true }\n  ]\n})\nexport default class Auth extends RcModule {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {Client} params.client - client module instance\n   * @param {Alert} params.alert - alert module instance\n   * @param {Brand} params.brand - brand module instance\n   * @param {Locale} params.locale - locale module instance\n   * @param {TabManager} params.tabManager - tabManager module instance\n   * @param {environment} params.Environment - environment module instance\n   * @param {String} params.redirectUri - redirect uri\n   * @param {String} params.proxyUri - proxyUri module instance\n   * @param {Number} params.defaultProxyRetry - default proxy retry time 5000\n   */\n  constructor({\n    client,\n    alert,\n    redirectUri = getDefaultRedirectUri(),\n    proxyUri = getDefaultProxyUri(),\n    brand,\n    locale,\n    tabManager,\n    environment,\n    defaultProxyRetry = DEFAULT_PROXY_RETRY,\n    ...options\n  } = {}) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._client = ensureExist(client, 'client');\n    this._alert = ensureExist(alert, 'alert');\n    this._brand = ensureExist(brand, 'brand');\n    this._locale = ensureExist(locale, 'locale');\n    this._redirectUri = redirectUri;\n    this._proxyUri = proxyUri;\n    this._tabManager = tabManager;\n    this._environment = environment;\n    this._defaultProxyRetry = defaultProxyRetry;\n    this._reducer = getAuthReducer(this.actionTypes);\n    this._beforeLogoutHandlers = new Set();\n    this._afterLoggedInHandlers = new Set();\n    this._proxyFrame = null;\n    this._proxyFrameLoaded = false;\n    this._unbindEvents = null;\n    this._lastEnvironmentCounter = 0;\n  }\n  _bindEvents() {\n    if (this._unbindEvents) this._unbindEvents();\n\n    const platform = this._client.service.platform();\n    const client = this._client.service._client;\n    const onRequestError = (apiResponse) => {\n      if (\n        apiResponse instanceof Error &&\n        apiResponse.message === 'Roken revoked'\n      ) {\n        this.logout();\n      }\n    };\n\n    const onLoginSuccess = async () => {\n      this.store.dispatch({\n        type: this.actionTypes.loginSuccess,\n        token: platform.auth().data(),\n      });\n      const handlers = [...this._afterLoggedInHandlers];\n      for (const handler of handlers) {\n        await (async () => handler())();\n      }\n    };\n    const onLoginError = (error) => {\n      this.store.dispatch({\n        type: this.actionTypes.loginError,\n        error,\n      });\n      if (error) {\n        this._alert.danger({\n          message: authMessages.loginError,\n          payload: error,\n        });\n      }\n    };\n    const onLogoutSuccess = () => {\n      this.store.dispatch({\n        type: this.actionTypes.logoutSuccess,\n      });\n    };\n    const onLogoutError = (error) => {\n      platform._cache.clean();\n      this.store.dispatch({\n        type: this.actionTypes.logoutError,\n        error,\n      });\n      if (error) {\n        this._alert.danger({\n          message: authMessages.logoutError,\n          payload: error,\n        });\n      }\n    };\n    const onRefreshSuccess = () => {\n      this.store.dispatch({\n        type: this.actionTypes.refreshSuccess,\n        token: platform.auth().data(),\n      });\n    };\n    const onRefreshError = (error) => {\n      // user is still considered logged in if the refreshToken is still valid\n\n      const refreshTokenValid = error.message === 'Failed to fetch' && platform.auth().refreshTokenValid();\n      this.store.dispatch({\n        type: this.actionTypes.refreshError,\n        error,\n        refreshTokenValid,\n      });\n      if (!refreshTokenValid && this._client.service.platform().auth().data().access_token !== '') {\n        this._alert.danger({\n          message: authMessages.sessionExpired,\n          payload: error,\n          ttl: 0,\n        });\n        // clean the cache so the error doesn't show again\n        platform._cache.clean();\n      }\n    };\n    platform.addListener(platform.events.loginSuccess, onLoginSuccess);\n    platform.addListener(platform.events.loginError, onLoginError);\n    platform.addListener(platform.events.logoutSuccess, onLogoutSuccess);\n    platform.addListener(platform.events.logoutError, onLogoutError);\n    platform.addListener(platform.events.refreshSuccess, onRefreshSuccess);\n    platform.addListener(platform.events.refreshError, onRefreshError);\n    client.addListener(client.events.requestError, onRequestError);\n    this._unbindEvents = () => {\n      platform.removeListener(platform.events.loginSuccess, onLoginSuccess);\n      platform.removeListener(platform.events.loginError, onLoginError);\n      platform.removeListener(platform.events.logoutSuccess, onLogoutSuccess);\n      platform.removeListener(platform.events.logoutError, onLogoutError);\n      platform.removeListener(platform.events.refreshSuccess, onRefreshSuccess);\n      platform.removeListener(platform.events.refreshError, onRefreshError);\n      client.removeListener(client.events.requestError, onRequestError);\n    };\n  }\n  initialize() {\n    let loggedIn;\n    this.store.subscribe(async () => {\n      if (\n        this.status === moduleStatuses.pending &&\n        this._locale.ready &&\n        (!this._tabManager || this._tabManager.ready) &&\n        (!this._environment || this._environment.ready)\n      ) {\n        this.store.dispatch({\n          type: this.actionTypes.init,\n        });\n        const platform = this._client.service.platform();\n        loggedIn = await platform.loggedIn();\n        this._bindEvents();\n        this.store.dispatch({\n          type: this.actionTypes.initSuccess,\n          loggedIn,\n          token: loggedIn ? platform.auth().data() : null,\n        });\n      }\n      if (\n        (this._tabManager && this._tabManager.ready) &&\n        this.ready\n      ) {\n        if (\n          (loggedIn && this.loginStatus === loginStatus.notLoggedIn) ||\n          (!loggedIn && this.loginStatus === loginStatus.loggedIn)\n        ) {\n          loggedIn = !loggedIn;\n          this._tabManager.send('loginStatusChange', loggedIn);\n        } else if (\n          this._tabManager.event &&\n          this._tabManager.event.name === 'loginStatusChange' &&\n          this._tabManager.event.args[0] !== loggedIn\n        ) {\n          /* eslint { \"prefer-destructuring\": 0 } */\n          loggedIn = this._tabManager.event.args[0];\n          this.store.dispatch({\n            type: this.actionTypes.tabSync,\n            loggedIn,\n            token: loggedIn ? this._client.service.platform().auth().data() : null,\n          });\n        }\n      }\n      if (\n        this.ready &&\n        this._environment &&\n        this._environment.changeCounter !== this._lastEnvironmentCounter\n      ) {\n        this._lastEnvironmentCounter = this._environment.changeCounter;\n        this._bindEvents();\n      }\n    });\n  }\n\n  get redirectUri() {\n    return url.resolve(window.location.href, this._redirectUri);\n  }\n\n  get proxyUri() {\n    return this._proxyUri;\n  }\n\n  get token() {\n    return this.state.token;\n  }\n\n  get ownerId() {\n    return this.token.ownerId;\n  }\n\n  get endpointId() {\n    return this.token.endpointId;\n  }\n\n  get accessToken() {\n    return this.token.accessToken;\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatuses.ready;\n  }\n\n  get loginStatus() {\n    return this.state.loginStatus;\n  }\n\n  get isFreshLogin() {\n    return this.state.freshLogin;\n  }\n\n  get proxyLoaded() {\n    return this.state.proxyLoaded;\n  }\n\n  get proxyRetryCount() {\n    return this.state.proxyRetryCount;\n  }\n\n  /**\n   * @function\n   * @param {String} options.username\n   * @param {String} options.password\n   * @param {String} options.extension\n   * @param {Booleal|Number} options.remember\n   * @param {String} params.code,\n   * @param {String} params.redirectUri,\n   * @return {Promise}\n   * @description Login either with username/password or with authorization code\n   */\n  @proxify\n  async login({\n    username, password, extension, remember, code, redirectUri\n  }) {\n    this.store.dispatch({\n      type: this.actionTypes.login,\n    });\n    return this._client.service.platform().login({\n      username,\n      password,\n      extension,\n      remember,\n      code,\n      redirectUri,\n    });\n  }\n  /**\n   * @function\n   * @param {String} options.redirectUri\n   * @param {String} options.brandId\n   * @param {Boolean} options.force\n   * @return {String}\n   * @description get OAuth page url\n   */\n  getLoginUrl({\n    redirectUri, state, brandId, display, prompt, force\n  }) {\n    return `${this._client.service.platform().loginUrl({\n      redirectUri,\n      state,\n      brandId,\n      display,\n      prompt,\n    })}${force ? '&force' : ''}`;\n  }\n\n  /**\n   * @function\n   * @description Triggers the beforeLogoutHandlers to run\n   *  and then proceed to logout from ringcentral.\n   */\n  @proxify\n  async logout() {\n    this.store.dispatch({\n      type: this.actionTypes.beforeLogout,\n    });\n    const handlers = [...this._beforeLogoutHandlers];\n    try {\n      for (const handler of handlers) {\n        const result = await (async () => handler())();\n        if (result) {\n          this.store.dispatch({\n            type: this.actionTypes.cancelLogout,\n          });\n          return Promise.reject(result);\n        }\n      }\n    } catch (error) {\n      this._alert.danger({\n        message: authMessages.beforeLogoutError,\n        payload: error,\n      });\n    }\n    this.store.dispatch({\n      type: this.actionTypes.logout,\n    });\n    return this._client.service.platform().logout();\n  }\n\n  /**\n  * @function\n  * @param {Function} handler\n  * @returns {Function}\n  */\n  addBeforeLogoutHandler(handler) {\n    this._beforeLogoutHandlers.add(handler);\n    return () => {\n      this.removeBeforeLogoutHandler(handler);\n    };\n  }\n\n  /**\n  * @function\n  * @param {Function} handler\n  */\n  removeBeforeLogoutHandler(handler) {\n    this._beforeLogoutHandlers.remove(handler);\n  }\n\n  addAfterLoggedInHandler(handler) {\n    this._afterLoggedInHandlers.add(handler);\n    return () => {\n      this._afterLoggedInHandlers.remove(handler);\n    };\n  }\n\n  @proxify\n  async checkIsLoggedIn() {\n    // SDK would return false when there's temporary network issues,\n    // but we should not return use back to welcome string and should\n    // still consider the user as being logged in.\n    await this._client.service.platform().loggedIn();\n    return this.state.loginStatus === loginStatus.loggedIn;\n  }\n\n  get loggedIn() {\n    return this.state.loginStatus === loginStatus.loggedIn ||\n      this.state.loginStatus === loginStatus.beforeLogout;\n  }\n\n  get notLoggedIn() {\n    return this.state.loginStatus === loginStatus.notLoggedIn;\n  }\n\n  _createProxyFrame = (onLogin) => {\n    this._proxyFrame = document.createElement('iframe');\n    this._proxyFrame.src = this.proxyUri;\n    this._proxyFrame.style.display = 'none';\n    this._proxyFrame.setAttribute('sandbox', [\n      'allow-scripts',\n      'allow-popups',\n      'allow-same-origin',\n      'allow-forms',\n    ].join(' '));\n\n    document.body.appendChild(this._proxyFrame);\n    this._callbackHandler = async ({ origin, data }) => {\n      // TODO origin check\n      if (data) {\n        const {\n          callbackUri,\n          proxyLoaded,\n          fromLocalStorage,\n        } = data;\n        if (\n          callbackUri &&\n          (\n            fromLocalStorage !== true ||\n            (!this._tabManager || this._tabManager.active)\n          )\n        ) {\n          try {\n            const code = parseCallbackUri(callbackUri);\n            if (code) {\n              await this.login({\n                code,\n                redirectUri: this.redirectUri,\n              });\n              if (typeof onLogin === 'function') {\n                onLogin();\n              }\n            }\n          } catch (error) {\n            let message;\n            switch (error.message) {\n              case 'invalid_request':\n              case 'unauthorized_client':\n              case 'access_denied':\n              case 'unsupported_response_type':\n              case 'invalid_scope':\n                message = authMessages.accessDenied;\n                break;\n              case 'server_error':\n              case 'temporarily_unavailable':\n              default:\n                message = authMessages.internalError;\n                break;\n            }\n\n            this._alert.danger({\n              message,\n              payload: error,\n            });\n          }\n        } else if (proxyLoaded) {\n          clearTimeout(this._retryTimeoutId);\n          this._retryTimeoutId = null;\n          this.store.dispatch({\n            type: this.actionTypes.proxyLoaded,\n          });\n        }\n      }\n    };\n    window.addEventListener('message', this._callbackHandler);\n    this._retryTimeoutId = setTimeout(() => {\n      this._retrySetupProxyFrame(onLogin);\n    }, this._defaultProxyRetry);\n  }\n  /**\n   * @function\n   * @description Create the proxy frame and append to document if available.\n   * @param {Function} onLogin - Function to be called when user successfully logged in\n   *  through oAuth.\n   */\n  async setupProxyFrame(onLogin) {\n    if (\n      !this._transport && // skip on proxy instance\n      typeof window !== 'undefined' &&\n      typeof document !== 'undefined' &&\n      this._proxyUri &&\n      this._proxyUri !== '' &&\n      !this._proxyFrame\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.proxySetup,\n      });\n      this._createProxyFrame(onLogin);\n    }\n  }\n  _retrySetupProxyFrame(onLogin) {\n    this._retryTimeoutId = null;\n    if (!this.proxyLoaded) {\n      this.store.dispatch({\n        type: this.actionTypes.proxyRetry,\n      });\n      this._destroyProxyFrame();\n      this._createProxyFrame(onLogin);\n    }\n  }\n  _destroyProxyFrame() {\n    document.body.removeChild(this._proxyFrame);\n    this._proxyFrame = null;\n    window.removeEventListener('message', this._callbackHandler);\n    this._callbackHandler = null;\n  }\n\n  async clearProxyFrame() {\n    if (this._proxyFrame) {\n      if (this._retryTimeoutId) {\n        clearTimeout(this._retryTimeoutId);\n        this._retryTimeoutId = null;\n      }\n      this._destroyProxyFrame();\n      this.store.dispatch({\n        type: this.actionTypes.proxyCleared,\n      });\n    }\n  }\n\n  @proxify\n  openOAuthPage() {\n    if (this.proxyLoaded) {\n      const extendedQuery = qs.stringify({\n        force: true,\n        localeId: this._locale.currentLocale,\n        ui_options: 'hide_remember_me hide_tos',\n      });\n      this._proxyFrame.contentWindow.postMessage({\n        oAuthUri: `${this.getLoginUrl({\n          redirectUri: this.redirectUri,\n          brandId: this._brand.id,\n          state: btoa(Date.now()),\n          display: 'page',\n        })}&${extendedQuery}`,\n      }, '*');\n    }\n  }\n}\n"]}