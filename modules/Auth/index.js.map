{"version":3,"sources":["modules/Auth/index.js"],"names":["DEFAULT_PROXY_RETRY","getDefaultRedirectUri","window","resolve","location","href","getDefaultProxyUri","Auth","client","alert","redirectUri","proxyUri","brand","locale","tabManager","environment","defaultProxyRetry","options","actionTypes","_createProxyFrame","onLogin","_proxyFrame","document","createElement","src","style","display","body","appendChild","_callbackHandler","origin","data","callbackUri","proxyLoaded","code","parseCallbackUri","login","message","accessDenied","internalError","_alert","danger","payload","clearTimeout","_retryTimeoutId","store","dispatch","type","addEventListener","setTimeout","_retrySetupProxyFrame","_defaultProxyRetry","_client","_brand","_locale","_redirectUri","_proxyUri","_tabManager","_environment","_reducer","_beforeLogoutHandlers","_proxyFrameLoaded","platform","service","on","events","loginSuccess","token","auth","loginError","error","logoutSuccess","logoutError","refreshSuccess","refreshError","refreshTokenValid","access_token","sessionExpired","ttl","_cache","clean","loggedIn","_bindEvents","subscribe","status","pending","ready","init","initSuccess","loginStatus","notLoggedIn","send","event","name","args","tabSync","changed","username","password","extension","remember","state","brandId","prompt","force","loginUrl","parse","query","Error","key","Object","prototype","hasOwnProperty","beforeLogout","handlers","handler","result","cancelLogout","reject","beforeLogoutError","logout","add","removeBeforeLogoutHandler","remove","proxySetup","proxyRetry","_destroyProxyFrame","removeChild","removeEventListener","proxyCleared","contentWindow","postMessage","oAuthUri","getLoginUrl","id","encodeURIComponent","currentLocale","ownerId","freshLogin","proxyRetryCount"],"mappings":"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","file":"index.js","sourcesContent":["import RcModule from '../../lib/RcModule';\nimport url from 'url';\nimport getAuthReducer from './getAuthReducer';\nimport actionTypes from './actionTypes';\nimport loginStatus from './loginStatus';\nimport authMessages from './authMessages';\nimport moduleStatus from '../../enums/moduleStatus';\n\nconst DEFAULT_PROXY_RETRY = 5000;\n\nfunction getDefaultRedirectUri() {\n  if (typeof window !== 'undefined') {\n    return url.resolve(window.location.href, './redirect.html');\n  }\n  return null;\n}\n\nfunction getDefaultProxyUri() {\n  if (typeof window !== 'undefined') {\n    return url.resolve(window.location.href, './proxy.html');\n  }\n  return null;\n}\n\n/**\n * @class\n * @description Authentication module\n */\nexport default class Auth extends RcModule {\n  /**\n   * @constructor\n   */\n  constructor({\n    client,\n    alert,\n    redirectUri = getDefaultRedirectUri(),\n    proxyUri = getDefaultProxyUri(),\n    brand,\n    locale,\n    tabManager,\n    environment,\n    defaultProxyRetry = DEFAULT_PROXY_RETRY,\n    ...options\n  } = {}) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._client = client;\n    this._alert = alert;\n    this._brand = brand;\n    this._locale = locale;\n    this._redirectUri = redirectUri;\n    this._proxyUri = proxyUri;\n    this._tabManager = tabManager;\n    this._environment = environment;\n    this._defaultProxyRetry = defaultProxyRetry;\n    this._reducer = getAuthReducer(this.actionTypes);\n    this._beforeLogoutHandlers = new Set();\n    this._proxyFrame = null;\n    this._proxyFrameLoaded = false;\n  }\n  _bindEvents() {\n    const platform = this._client.service.platform();\n    platform.on(platform.events.loginSuccess, () => {\n      this.store.dispatch({\n        type: this.actionTypes.loginSuccess,\n        token: platform.auth().data(),\n      });\n    });\n    platform.on(platform.events.loginError, error => {\n      this.store.dispatch({\n        type: this.actionTypes.loginError,\n        error,\n      });\n      if (error) {\n        this._alert.danger({\n          message: authMessages.loginError,\n          payload: error,\n        });\n      }\n    });\n    platform.on(platform.events.logoutSuccess, () => {\n      this.store.dispatch({\n        type: this.actionTypes.logoutSuccess,\n      });\n    });\n    platform.on(platform.events.logoutError, error => {\n      this.store.dispatch({\n        type: this.actionTypes.logoutError,\n        error,\n      });\n      if (error) {\n        this._alert.danger({\n          message: authMessages.logoutError,\n          payload: error,\n        });\n      }\n    });\n    platform.on(platform.events.refreshSuccess, () => {\n      this.store.dispatch({\n        type: this.actionTypes.refreshSuccess,\n        token: platform.auth().data(),\n      });\n    });\n    platform.on(platform.events.refreshError, error => {\n      // user is still considered logged in if the refreshToken is still valid\n      const refreshTokenValid = platform.auth().refreshTokenValid();\n      this.store.dispatch({\n        type: this.actionTypes.refreshError,\n        error,\n        refreshTokenValid,\n      });\n      if (!refreshTokenValid && this._client.service.platform().auth().data().access_token !== '') {\n        this._alert.danger({\n          message: authMessages.sessionExpired,\n          payload: error,\n          ttl: 0,\n        });\n        // clean the cache so the error doesn't show again\n        platform._cache.clean();\n      }\n    });\n  }\n  initialize() {\n    let loggedIn;\n    this._bindEvents();\n    this.store.subscribe(async () => {\n      if (\n        this.status === moduleStatus.pending &&\n        this._locale.ready &&\n        (!this._tabManager || this._tabManager.ready) &&\n        (!this._environment || this._environment.ready)\n      ) {\n        this.store.dispatch({\n          type: this.actionTypes.init,\n        });\n        const platform = this._client.service.platform();\n        loggedIn = await platform.loggedIn();\n        this.store.dispatch({\n          type: this.actionTypes.initSuccess,\n          loggedIn,\n          token: loggedIn ? platform.auth().data() : null,\n        });\n      }\n      if (\n        this._tabManager &&\n        this._tabManager.ready &&\n        this.ready\n      ) {\n        if (\n          loggedIn && this.loginStatus === loginStatus.notLoggedIn ||\n          !loggedIn && this.loginStatus === loginStatus.loggedIn\n        ) {\n          loggedIn = !loggedIn;\n          this._tabManager.send('loginStatusChange', loggedIn);\n        } else if (\n          this._tabManager.event &&\n          this._tabManager.event.name === 'loginStatusChange' &&\n          this._tabManager.event.args[0] !== loggedIn\n        ) {\n          loggedIn = this._tabManager.event.args[0];\n          this.store.dispatch({\n            type: this.actionTypes.tabSync,\n            loggedIn,\n            token: loggedIn ? this._client.service.platform().auth().data() : null,\n          });\n        }\n      }\n      if (\n        this.ready &&\n        this._environment &&\n        this._environment.changed\n      ) {\n        this._bindEvents();\n      }\n    });\n  }\n\n  get redirectUri() {\n    return this._redirectUri;\n  }\n\n  get proxyUri() {\n    return this._proxyUri;\n  }\n\n  get ownerId() {\n    return this.state.ownerId;\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatus.ready;\n  }\n\n  get loginStatus() {\n    return this.state.loginStatus;\n  }\n\n  get isFreshLogin() {\n    return this.state.freshLogin;\n  }\n\n  get proxyLoaded() {\n    return this.state.proxyLoaded;\n  }\n\n  get proxyRetryCount() {\n    return this.state.proxyRetryCount;\n  }\n\n  /**\n   * @function\n   * @param {String} options.username\n   * @param {String} options.password\n   * @param {String} options.extension\n   * @param {Booleal|Number} options.remember\n   * @param {String} params.code,\n   * @param {String} params.redirectUri,\n   * @return {Promise}\n   * @description Login either with username/password or with authorization code\n   */\n  async login({ username, password, extension, remember, code, redirectUri }) {\n    this.store.dispatch({\n      type: this.actionTypes.login,\n    });\n    return await this._client.service.platform().login({\n      username,\n      password,\n      extension,\n      remember,\n      code,\n      redirectUri,\n    });\n  }\n  /**\n   * @function\n   * @param {String} options.redirectUri\n   * @param {String} options.brandId\n   * @param {Boolean} options.force\n   * @return {String}\n   * @description get OAuth page url\n   */\n  getLoginUrl({ redirectUri, state, brandId, display, prompt, force }) {\n    return `${this._client.service.platform().loginUrl({\n      redirectUri,\n      state,\n      brandId,\n      display,\n      prompt,\n    })}${force ? '&force' : ''}`;\n  }\n  /**\n   * @function\n   * @param {String} callbackUri\n   * @return {String} code\n   */\n  parseCallbackUri(callbackUri) {\n    const { query } = url.parse(callbackUri, true);\n    if (query.error) {\n      const error = new Error(query.error);\n      for (const key in query) {\n        if (query::Object.prototype.hasOwnProperty(key)) {\n          error[key] = query[key];\n        }\n      }\n      throw error;\n    }\n    return query.code;\n  }\n\n  /**\n   * @function\n   * @description Triggers the beforeLogoutHandlers to run\n   *  and then proceed to logout from ringcentral.\n   */\n  async logout() {\n    this.store.dispatch({\n      type: this.actionTypes.beforeLogout,\n    });\n    const handlers = [...this._beforeLogoutHandlers];\n    try {\n      for (const handler of handlers) {\n        const result = await (async () => handler())();\n        if (result) {\n          this.store.dispatch({\n            type: this.actionTypes.cancelLogout,\n          });\n          return Promise.reject(result);\n        }\n      }\n    } catch (error) {\n      this._alert.danger({\n        message: authMessages.beforeLogoutError,\n        payload: error,\n      });\n    }\n    this.store.dispatch({\n      type: this.actionTypes.logout,\n    });\n    return await this._client.service.platform().logout();\n  }\n\n  /**\n  * @function\n  * @param {Function} handler\n  * @returns {Function}\n  */\n  addBeforeLogoutHandler(handler) {\n    this._beforeLogoutHandlers.add(handler);\n    return () => {\n      this.removeBeforeLogoutHandler(handler);\n    };\n  }\n\n  /**\n  * @function\n  * @param {Function} handler\n  */\n  removeBeforeLogoutHandler(handler) {\n    this._beforeLogoutHandlers.remove(handler);\n  }\n\n  async checkIsLoggedIn() {\n    // SDK would return false when there's temporary network issues,\n    // but we should not return use back to welcome string and should\n    // still consider the user as being logged in.\n    await this._client.service.platform().loggedIn();\n    return this.state.loginStatus === loginStatus.loggedIn;\n  }\n\n  get loggedIn() {\n    return this.state.loginStatus === loginStatus.loggedIn ||\n      this.state.loginStatus === loginStatus.beforeLogout;\n  }\n  _createProxyFrame = (onLogin) => {\n    this._proxyFrame = document.createElement('iframe');\n    this._proxyFrame.src = this.proxyUri;\n    this._proxyFrame.style.display = 'none';\n\n    document.body.appendChild(this._proxyFrame);\n    this._callbackHandler = async ({ origin, data }) => {\n      // TODO origin check\n      if (data) {\n        const {\n          callbackUri,\n          proxyLoaded,\n        } = data;\n        if (callbackUri) {\n          try {\n            const code = this.parseCallbackUri(callbackUri);\n            if (code) {\n              await this.login({\n                code,\n                redirectUri: this.redirectUri,\n              });\n              if (typeof onLogin === 'function') {\n                onLogin();\n              }\n            }\n          } catch (error) {\n            let message;\n            switch (error.message) {\n              case 'invalid_request':\n              case 'unauthorized_client':\n              case 'access_denied':\n              case 'unsupported_response_type':\n              case 'invalid_scope':\n                message = authMessages.accessDenied;\n                break;\n              case 'server_error':\n              case 'temporarily_unavailable':\n              default:\n                message = authMessages.internalError;\n                break;\n            }\n\n            this._alert.danger({\n              message,\n              payload: error,\n            });\n          }\n        } else if (proxyLoaded) {\n          clearTimeout(this._retryTimeoutId);\n          this._retryTimeoutId = null;\n          this.store.dispatch({\n            type: this.actionTypes.proxyLoaded,\n          });\n        }\n      }\n    };\n    window.addEventListener('message', this._callbackHandler);\n    this._retryTimeoutId = setTimeout(() => {\n      this._retrySetupProxyFrame(onLogin);\n    }, this._defaultProxyRetry);\n  }\n  /**\n   * @function\n   * @description Create the proxy frame and append to document if available.\n   * @param {Function} onLogin - Function to be called when user successfully logged in\n   *  through oAuth.\n   */\n  setupProxyFrame(onLogin) {\n    if (\n      typeof window !== 'undefined' &&\n      typeof document !== 'undefined' &&\n      this._proxyUri &&\n      this._proxyUri !== '' &&\n      !this._proxyFrame\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.proxySetup,\n      });\n      this._createProxyFrame(onLogin);\n    }\n  }\n  _retrySetupProxyFrame(onLogin) {\n    this._retryTimeoutId = null;\n    if (!this.proxyLoaded) {\n      this.store.dispatch({\n        type: this.actionTypes.proxyRetry,\n      });\n      this._destroyProxyFrame();\n      this._createProxyFrame(onLogin);\n    }\n  }\n  _destroyProxyFrame() {\n    document.body.removeChild(this._proxyFrame);\n    this._proxyFrame = null;\n    window.removeEventListener('message', this._callbackHandler);\n    this._callbackHandler = null;\n  }\n  clearProxyFrame() {\n    if (this._proxyFrame) {\n      if (this._retryTimeoutId) {\n        clearTimeout(this._retryTimeoutId);\n        this._retryTimeoutId = null;\n      }\n      this._destroyProxyFrame();\n      this.store.dispatch({\n        type: this.actionTypes.proxyCleared,\n      });\n    }\n  }\n  openOAuthPage() {\n    if (this.proxyLoaded) {\n      this._proxyFrame.contentWindow.postMessage({\n        oAuthUri: `${this.getLoginUrl({\n          redirectUri: this.redirectUri,\n          brandId: this._brand.id,\n        })}&force=true&localeId=${encodeURIComponent(this._locale.currentLocale)}`,\n      }, '*');\n    }\n  }\n}\n"]}