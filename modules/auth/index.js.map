{"version":3,"sources":["modules/auth/index.js"],"names":["logger","prefix","symbols","Auth","options","actions","sdk","on","oldState","newState","status","emit","authStatusChange","oldStatus","newStatus","platform","beforeLogoutHandlers","events","loginSuccess","store","dispatch","type","token","auth","data","loginError","error","logoutSuccess","logoutError","refreshSuccess","refreshError","loggedIn","init","notLoggedIn","username","password","extension","remember","login","payload","redirectUri","state","brandId","display","prompt","loginUrl","url","parseLoginRedirectUrl","code","logout","handlers","handler","add","remove","owner_id"],"mappings":"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","file":"index.js","sourcesContent":["import RcModule, { initFunction } from '../../lib/rc-module';\nimport { proxify, throwOnProxy } from '../proxy';\nimport SymbolMap from 'data-types/symbol-map';\nimport authStatus from './auth-status';\nimport authActions from './auth-actions';\nimport getAuthReducer from './get-auth-reducer';\nimport authEvents from './auth-events';\nimport Loganberry from 'loganberry';\n\nconst logger = new Loganberry({\n  prefix: 'auth',\n});\n\nconst symbols = new SymbolMap([\n  'sdk',\n  'emitter',\n  'beforeLogoutHandlers',\n  'init',\n]);\n\n/**\n * @class\n * @description Authentication module\n */\nexport default class Auth extends RcModule {\n  /**\n   * @function\n   */\n  constructor(options) {\n    super({\n      ...options,\n      actions: authActions,\n    });\n\n    const {\n      sdk,\n    } = options;\n    this.on('state-change', ({ oldState, newState }) => {\n      if (!oldState || oldState.status !== newState.status) {\n        this.emit(\n          authEvents.authStatusChange,\n          {\n            oldStatus: oldState && oldState.status,\n            newStatus: newState.status,\n          }\n        );\n        this.emit(newState.status);\n      }\n    });\n    this[symbols.sdk] = sdk;\n  }\n  @initFunction\n  init() {\n    const platform = this[symbols.sdk].platform();\n    this[symbols.beforeLogoutHandlers] = new Set();\n\n    // load info on login\n    platform.on(platform.events.loginSuccess, () => {\n      this.store.dispatch({\n        type: this.actions.loginSuccess,\n        token: platform.auth().data(),\n      });\n    });\n    // loginError\n    platform.on(platform.events.loginError, error => {\n      this.store.dispatch({\n        type: this.actions.loginError,\n        error,\n      });\n    });\n    // unload info on logout\n    platform.on(platform.events.logoutSuccess, () => {\n      this.store.dispatch({\n        type: this.actions.logoutSuccess,\n      });\n    });\n\n    platform.on(platform.events.logoutError, error => {\n      this.store.dispatch({\n        type: this.actions.logoutError,\n        error,\n      });\n    });\n    platform.on(platform.events.refreshSuccess, () => {\n      this.store.dispatch({\n        type: this.actions.refreshSuccess,\n        token: platform.auth().data(),\n      });\n    });\n    platform.on(platform.events.refreshError, error => {\n      this.store.dispatch({\n        type: this.actions.refreshError,\n        error,\n      });\n    });\n\n    // load info if already logged in\n    (async () => {\n      const loggedIn = await platform.loggedIn();\n      this.store.dispatch({\n        type: this.actions.init,\n        status: loggedIn ? authStatus.loggedIn : authStatus.notLoggedIn,\n        token: loggedIn ? platform.auth().data() : null,\n      });\n    })();\n  }\n\n  get reducer() {\n    return getAuthReducer(this.prefix);\n  }\n  /**\n   * @function\n   * @async\n   * @description Login function using username and password\n   */\n  @proxify\n  async login({ username, password, extension, remember }) {\n    this.store.dispatch({\n      type: this.actions.login,\n      payload: {\n        username,\n        password,\n        extension,\n        remember,\n      },\n    });\n    return await this[symbols.sdk].platform().login({\n      username,\n      password,\n      extension,\n      remember,\n    });\n  }\n\n  /**\n   * @function\n   * @description get OAuth page url\n   */\n  loginUrl({ redirectUri, state, brandId, display, prompt }) {\n    return this[symbols.sdk].platform().loginUrl({\n      redirectUri,\n      state,\n      brandId,\n      display,\n      prompt,\n    });\n  }\n\n  /**\n   * @function\n   * @param {string} url\n   * @return {Object}\n   */\n  parseLoginUrl(url) {\n    return this[symbols.sdk].platform().parseLoginRedirectUrl(url);\n  }\n\n  /**\n   * @function\n   * @async\n   * @description Authorize using OAauth code\n   */\n  @proxify\n  async authorize({ code, redirectUri }) {\n    this.store.dispatch({\n      type: this.actions.login,\n      payload: {\n        code,\n        redirectUri,\n      },\n    });\n    return await this[symbols.sdk].platform().login({\n      code,\n      redirectUri,\n    });\n  }\n\n  /**\n   * @function\n   * @async\n   * @description Log the user out\n   */\n  @proxify\n  async logout() {\n    // deal with removing subscriptions\n    this.store.dispatch({\n      type: this.actions.logout,\n    });\n    const handlers = [...this[symbols.beforeLogoutHandlers]];\n    for (const handler of handlers) {\n      try {\n        // wraps with async so even normal functions can be awaited\n        // TODO cancel logout if handler resolves to false\n        await (async () => handler())();\n      } catch (e) {\n        // TODO: should emit error\n      }\n    }\n    return await this[symbols.sdk].platform().logout();\n  }\n  /**\n   * @function\n   * @param {Function} handler\n   * @returns {Function}\n   */\n  @throwOnProxy\n  addBeforeLogoutHandler(handler) {\n    this[symbols.beforeLogoutHandlers].add(handler);\n    return () => {\n      this[symbols.beforeLogoutHandlers].remove(handler);\n    };\n  }\n  /**\n   * @function\n   * @param {Function} handler\n   */\n  @throwOnProxy\n  removeBeforeLogoutHandler(handler) {\n    this[symbols.beforeLogoutHandlers].remove(handler);\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get authEvents() {\n    return authEvents;\n  }\n\n  get authStatus() {\n    return authStatus;\n  }\n\n  get ownerId() {\n    return this.state.token.owner_id;\n  }\n\n  @proxify\n  async isLoggedIn() {\n    return await this[symbols.sdk].platform().loggedIn();\n  }\n}\n\n"]}