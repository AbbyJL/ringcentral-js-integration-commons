{"version":3,"sources":["modules/CallHistory/index.js"],"names":["CallHistory","deps","dep","optional","accountInfo","callLog","callMonitor","activityMatcher","contactMatcher","options","_accountInfo","_callLog","_activityMatcher","_contactMatcher","_callMonitor","_reducer","actionTypes","addQuerySource","getQueriesFn","uniqueNumbers","readyCheckFn","ready","sessionIds","store","subscribe","_onStateChange","_shouldInit","_initModuleStatus","_shouldReset","_resetModuleStatus","_processCallHistory","pending","_lastProcessedNumbers","_lastProcessedIds","monitorCalls","calls","callLogCalls","_lastProcessedMonitorCalls","endedCalls","filter","find","call","sessionId","currentCall","currentCalls","_lastProcessedCalls","ids","forEach","recentlyEndedCalls","_shouldTriggerContactMatch","triggerMatch","_shouldTriggerActivityMatch","_getEndedCalls","length","_addEndedCalls","shouldRemove","_shouldRemoveEndedCalls","_removeEndedCalls","dispatch","type","init","initSuccess","reset","resetSuccess","map","result","addEndedCalls","timestamp","Date","now","sync","removeEndedCalls","clickToSMS","clickToCall","state","status","countryCode","callFrom","from","phoneNumber","callTo","to","sort","normalizedCalls","dataMapping","callMatched","contactMapping","activityMapping","fromNumber","extensionNumber","toNumber","fromMatches","toMatches","activityMatches","matched","toNumberEntity","output","numberMap","addIfNotExist","number","push","addNumbersFromCall","concat"],"mappings":"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","file":"index.js","sourcesContent":["import { createSelector } from 'reselect';\nimport RcModule from '../../lib/RcModule';\nimport { Module } from '../../lib/di';\nimport moduleStatuses from '../../enums/moduleStatuses';\nimport {\n  sortByStartTime,\n} from '../../lib/callLogHelpers';\nimport actionTypes from './actionTypes';\nimport getCallHistoryReducer from './getCallHistoryReducer';\nimport ensureExist from '../../lib/ensureExist';\nimport normalizeNumber from '../../lib/normalizeNumber';\nimport getter from '../../lib/getter';\nimport proxify from '../../lib/proxy/proxify';\n\n/**\n * @class\n * @description Call history managing module\n */\n@Module({\n  deps: [\n    'AccountInfo',\n    'CallLog',\n    'CallMonitor',\n    { dep: 'ActivityMatcher', optional: true },\n    { dep: 'ContactMatcher', optional: true },\n    { dep: 'CallHistoryOptions', optional: true }\n  ]\n})\nexport default class CallHistory extends RcModule {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {AccountInfo} params.accountInfo - accountInfo module instance\n   * @param {CallLog} params.callLog - callLog module instance\n   * @param {CallMonitor} params.callMonitor - callMonitor module instance\n   * @param {ActivityMatcher} params.activityMatcher - activityMatcher module instance\n   * @param {ContactMatcher} params.contactMatcher - contactMatcher module instance\n   */\n  constructor({\n    accountInfo,\n    callLog,\n    callMonitor,\n    activityMatcher,\n    contactMatcher,\n    ...options\n  }) {\n    super({\n      ...options,\n    });\n    this._accountInfo = this::ensureExist(accountInfo, 'accountInfo');\n    this._callLog = this::ensureExist(callLog, 'callLog');\n    this._activityMatcher = activityMatcher;\n    this._contactMatcher = contactMatcher;\n    this._callMonitor = callMonitor;\n    this._reducer = getCallHistoryReducer(this.actionTypes);\n\n    if (this._contactMatcher) {\n      this._contactMatcher.addQuerySource({\n        getQueriesFn: () => this.uniqueNumbers,\n        readyCheckFn: () => (\n          (!this._callMonitor || this._callMonitor.ready) &&\n          this._callLog.ready &&\n          this._accountInfo.ready\n        ),\n      });\n    }\n    if (this._activityMatcher) {\n      this._activityMatcher.addQuerySource({\n        getQueriesFn: () => this.sessionIds,\n        readyCheckFn: () => (\n          (!this._callMonitor || this._callMonitor.ready) &&\n          this._callLog.ready\n        ),\n      });\n    }\n  }\n\n  get _actionTypes() {\n    return actionTypes;\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  async _onStateChange() {\n    if (this._shouldInit()) {\n      this._initModuleStatus();\n    } else if (this._shouldReset()) {\n      this._resetModuleStatus();\n    } else if (\n      this.ready\n    ) {\n      this._processCallHistory();\n    }\n  }\n\n  _shouldInit() {\n    return (\n      this._callLog.ready &&\n      (!this._callMonitor || this._callMonitor.ready) &&\n      this._accountInfo.ready &&\n      (!this._contactMatcher || this._contactMatcher.ready) &&\n      (!this._activityMatcher || this._activityMatcher.ready) &&\n      this.pending\n    );\n  }\n\n  _shouldReset() {\n    return (\n      (!this._callLog.ready ||\n        (this._callMonitor && !this._callMonitor.ready) ||\n        !this._accountInfo.ready ||\n        (this._contactMatcher && !this._contactMatcher.ready) ||\n        (this._activityMatcher && !this._activityMatcher.ready)\n      ) &&\n      this.ready\n    );\n  }\n\n  _shouldTriggerContactMatch(uniqueNumbers) {\n    if (this._lastProcessedNumbers !== uniqueNumbers) {\n      this._lastProcessedNumbers = uniqueNumbers;\n      if (this._contactMatcher && this._contactMatcher.ready) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  _shouldTriggerActivityMatch(sessionIds) {\n    if (this._lastProcessedIds !== sessionIds) {\n      this._lastProcessedIds = sessionIds;\n      if (this._activityMatcher && this._activityMatcher.ready) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  _getEndedCalls() {\n    if (this._callMonitor) {\n      const monitorCalls = this._callMonitor.calls;\n      const callLogCalls = this._callLog.calls;\n      if (this._lastProcessedMonitorCalls !== monitorCalls) {\n        const endedCalls = (this._lastProcessedMonitorCalls || [])\n          .filter(call => (\n            !monitorCalls.find(currentCall => call.sessionId === currentCall.sessionId) &&\n            // if the call's callLog has been fetch, skip\n            !callLogCalls.find(currentCall => call.sessionId === currentCall.sessionId)\n          ));\n        this._lastProcessedMonitorCalls = monitorCalls;\n        return endedCalls;\n      }\n    }\n    return null;\n  }\n\n  _shouldRemoveEndedCalls() {\n    const currentCalls = this._callLog.calls;\n    if (currentCalls !== this._lastProcessedCalls) {\n      this._lastProcessedCalls = currentCalls;\n      const ids = {};\n      currentCalls.forEach((call) => {\n        ids[call.sessionId] = true;\n      });\n      return this.recentlyEndedCalls.filter(call => ids[call.sessionId]);\n    }\n    return null;\n  }\n\n  _processCallHistory() {\n    const uniqueNumbers = this.uniqueNumbers;\n    if (this._shouldTriggerContactMatch(uniqueNumbers)) {\n      this._contactMatcher.triggerMatch();\n    }\n    const sessionIds = this.sessionIds;\n    if (this._shouldTriggerActivityMatch(sessionIds)) {\n      this._activityMatcher.triggerMatch();\n    }\n\n    const endedCalls = this._getEndedCalls();\n    if (endedCalls && endedCalls.length) {\n      this._addEndedCalls(endedCalls);\n    }\n\n    const shouldRemove = this._shouldRemoveEndedCalls();\n    if (shouldRemove && shouldRemove.length) {\n      this._removeEndedCalls(shouldRemove);\n    }\n  }\n\n  _initModuleStatus() {\n    this.store.dispatch({\n      type: this.actionTypes.init,\n    });\n    this.store.dispatch({\n      type: this.actionTypes.initSuccess,\n    });\n  }\n\n  _resetModuleStatus() {\n    this.store.dispatch({\n      type: this.actionTypes.reset,\n    });\n    this._lastProcessedCalls = null;\n    this._lastProcessedIds = null;\n    this._lastProcessedMonitorCalls = null;\n    this._lastProcessedNumbers = null;\n    this.store.dispatch({\n      type: this.actionTypes.resetSuccess,\n    });\n  }\n\n  _addEndedCalls(endedCalls) {\n    endedCalls.map((call) => {\n      call.result = 'Disconnected';\n      return call;\n    });\n    this.store.dispatch({\n      type: this.actionTypes.addEndedCalls,\n      endedCalls,\n      timestamp: Date.now(),\n    });\n    this._callLog.sync();\n  }\n\n  _removeEndedCalls(endedCalls) {\n    this.store.dispatch({\n      type: this.actionTypes.removeEndedCalls,\n      endedCalls,\n    });\n  }\n\n  // for track click to sms in call history\n  @proxify\n  onClickToSMS() {\n    this.store.dispatch({\n      type: this.actionTypes.clickToSMS\n    });\n  }\n  // for track click to call in call history\n  @proxify\n  onClickToCall() {\n    this.store.dispatch({\n      type: this.actionTypes.clickToCall,\n    });\n  }\n\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatuses.ready;\n  }\n\n  get pending() {\n    return this.state.status === moduleStatuses.pending;\n  }\n\n  @getter\n  normalizedCalls = createSelector(\n    () => this._callLog.calls,\n    () => this._accountInfo.countryCode,\n    (calls, countryCode) => (\n      calls.map((call) => {\n        const callFrom = {\n          ...call.from,\n        };\n        if (callFrom.phoneNumber) {\n          callFrom.phoneNumber = normalizeNumber({\n            phoneNumber: callFrom.phoneNumber,\n            countryCode,\n          });\n        }\n        const callTo = {\n          ...call.to,\n        };\n        if (callTo.phoneNumber) {\n          callTo.phoneNumber = normalizeNumber({\n            phoneNumber: callTo.phoneNumber,\n            countryCode,\n          });\n        }\n        return {\n          ...call,\n          from: callFrom,\n          to: callTo,\n        };\n      }).sort(sortByStartTime)\n    ),\n  )\n\n  @getter\n  calls = createSelector(\n    () => this.normalizedCalls,\n    () => this.state.endedCalls,\n    () => (this._contactMatcher && this._contactMatcher.dataMapping),\n    () => (this._activityMatcher && this._activityMatcher.dataMapping),\n    () => (this._callMonitor && this._callMonitor.callMatched),\n    (\n      normalizedCalls,\n      endedCalls,\n      contactMapping = {},\n      activityMapping = {},\n      callMatched = {}\n    ) => {\n      const sessionIds = {};\n      const calls = normalizedCalls.map((call) => {\n        sessionIds[call.sessionId] = true;\n        const fromNumber = call.from && (call.from.phoneNumber || call.from.extensionNumber);\n        const toNumber = call.to && (call.to.phoneNumber || call.to.extensionNumber);\n        const fromMatches = (fromNumber && contactMapping[fromNumber]) || [];\n        const toMatches = (toNumber && contactMapping[toNumber]) || [];\n        const activityMatches = (activityMapping[call.sessionId]) || [];\n        const matched = callMatched[call.sessionId];\n        return {\n          ...call,\n          fromMatches,\n          toMatches,\n          activityMatches,\n          toNumberEntity: matched,\n        };\n      });\n      return [\n        ...endedCalls.filter(call => !sessionIds[call.sessionId]).sort(sortByStartTime),\n        ...calls\n      ];\n    }\n  )\n\n  @getter\n  uniqueNumbers = createSelector(\n    () => this.normalizedCalls,\n    () => this.state.endedCalls,\n    (normalizedCalls, endedCalls) => {\n      const output = [];\n      const numberMap = {};\n      function addIfNotExist(number) {\n        if (!numberMap[number]) {\n          output.push(number);\n          numberMap[number] = true;\n        }\n      }\n      function addNumbersFromCall(call) {\n        if (call.from && call.from.phoneNumber) {\n          addIfNotExist(call.from.phoneNumber);\n        } else if (call.from && call.from.extensionNumber) {\n          addIfNotExist(call.from.extensionNumber);\n        }\n        if (call.to && call.to.phoneNumber) {\n          addIfNotExist(call.to.phoneNumber);\n        } else if (call.to && call.to.extensionNumber) {\n          addIfNotExist(call.to.extensionNumber);\n        }\n      }\n      normalizedCalls.forEach(addNumbersFromCall);\n      endedCalls.forEach(addNumbersFromCall);\n      return output;\n    },\n  )\n\n  @getter\n  sessionIds = createSelector(\n    () => this._callLog.calls,\n    () => this.state.endedCalls,\n    (calls, endedCalls) => {\n      const sessionIds = {};\n      return calls.map((call) => {\n        sessionIds[call.sessionId] = true;\n        return call.sessionId;\n      }).concat(\n        endedCalls\n          .filter(call => !sessionIds[call.sessionId])\n          .map(call => call.sessionId)\n      );\n    },\n  )\n\n  get recentlyEndedCalls() {\n    return this.state.endedCalls;\n  }\n}\n"]}