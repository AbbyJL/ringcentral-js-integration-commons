{"version":3,"sources":["modules/Storage/index.js"],"names":["Storage","auth","StorageProvider","options","actionTypes","_auth","_StorageProvider","_storage","_reducer","prefix","store","subscribe","status","authStatus","loggedIn","ready","storageKey","ownerId","initialData","getData","dispatch","type","init","data","_unsubscribe","actions","load","updatedData","notLoggedIn","pending","reset","destroy","addBeforeLogoutHandler","key","value","set","setData","Object","prototype","hasOwnProperty","remove","state"],"mappings":"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","file":"index.js","sourcesContent":["import RcModule from '../../lib/RcModule';\nimport NamedStorage from '../../lib/NamedStorage';\nimport storageStatus from './storageStatus';\nimport storageActionTypes from './storageActionTypes';\nimport getStorageReducer from './getStorageReducer';\n\nexport default class Storage extends RcModule {\n  constructor({\n    auth,\n    StorageProvider = NamedStorage,\n    ...options,\n  } = {}) {\n    super({\n      ...options,\n      actionTypes: storageActionTypes,\n    });\n    this._auth = auth;\n    this._StorageProvider = StorageProvider;\n    this._storage = null;\n    this._reducer = getStorageReducer(this.prefix);\n  }\n  initialize() {\n    this.store.subscribe(() => {\n      if (\n        this._auth.status === this._auth.authStatus.loggedIn &&\n        this.status !== storageStatus.ready\n      ) {\n        const storageKey = `${this.prefix ? `${this.prefix}-` : ''}storage-${this._auth.ownerId}`;\n        this._storage = new this._StorageProvider({ storageKey });\n\n        const initialData = this._storage.getData() || {};\n        this.store.dispatch({\n          type: this.actionTypes.init,\n          storageKey,\n          data: initialData,\n        });\n        this._unsubscribe = this._storage.subscribe(updatedData => {\n          if (this.status === storageStatus.ready) {\n            this.store.dispatch({\n              type: this.actions.load,\n              data: updatedData,\n            });\n          }\n        });\n      } else if (\n        this._auth.status === this._auth.authStatus.notLoggedIn &&\n        this.status !== storageStatus.pending\n      ) {\n        this.store.dispatch({\n          type: this.actionTypes.reset,\n        });\n        if (this._unsubscribe) {\n          this._unsubscribe();\n        }\n        if (this._storage) {\n          this._storage.destroy();\n          this._storage = null;\n        }\n      }\n    });\n    this._auth.addBeforeLogoutHandler(() => {\n      this.store.dispatch({\n        type: this.actionTypes.reset,\n      });\n      if (this._unsubscribe) {\n        this._unsubscribe();\n      }\n      if (this._storage) {\n        this._storage.destroy();\n        this._storage = null;\n      }\n    });\n  }\n\n  getItem(key) {\n    return this.data[key];\n  }\n\n  setItem(key, value) {\n    this.store.dispatch({\n      type: this.actionTypes.set,\n      key,\n      value,\n    });\n    this._storage.setData(this.data);\n  }\n\n  hasItem(key) {\n    return this.data::Object.prototype.hasOwnProperty(key);\n  }\n  removeItem(key) {\n    this.store.dispatch({\n      type: this.actionTypes.remove,\n      key,\n    });\n    this._storage.setData(this.data);\n  }\n\n  get data() {\n    return this.state.data;\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get storageStatus() {\n    return storageStatus;\n  }\n\n}\n"]}