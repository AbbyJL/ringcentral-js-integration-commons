{"version":3,"sources":["modules/Storage/index.js"],"names":["symbols","Storage","options","actions","StorageProvider","auth","storage","storageProvider","on","oldState","newState","status","emit","statusChange","oldStatus","newStatus","data","dataChange","oldData","newData","key","ready","authEvents","loggedIn","prefix","ownerId","error","saved","getData","dirty","store","dispatch","type","init","unsubscribeStorage","subscribe","load","notLoggedIn","pending","reset","destroy","value","setData","state","Error","update","version","save","saveSuccess","saveError","remove"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;;;AACA;;;;AACA;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA,IAAMA,UAAU,wBAAc,CAC5B,SAD4B,EAE5B,iBAF4B,EAG5B,oBAH4B,CAAd,CAAhB;;IAMqBC,O;;;AACnB,mBAAYC,OAAZ,EAAqB;AAAA;;AAAA,mKAEdA,OAFc;AAGjBC;AAHiB;;AAAA,gCAQfD,OARe,CAMjBE,eANiB;AAAA,QAMjBA,eANiB;AAAA,QAOjBC,IAPiB,GAQfH,OARe,CAOjBG,IAPiB;;AASnB,UAAKL,QAAQM,OAAb,IAAwB,IAAxB;AACA,UAAKN,QAAQO,eAAb,IAAgCH,eAAhC;AACA,UAAKJ,QAAQK,IAAb,IAAqBA,IAArB;;AAEA,UAAKG,EAAL,CAAQ,cAAR,EAAwB,gBAA4B;AAAA,UAAzBC,QAAyB,QAAzBA,QAAyB;AAAA,UAAfC,QAAe,QAAfA,QAAe;;AAClD,UAAID,QAAJ,EAAc;AACZ,YAAIA,SAASE,MAAT,KAAoBD,SAASC,MAAjC,EAAyC;AACvC,gBAAKC,IAAL,CACE,wBAAcC,YADhB,EAEE;AACEC,uBAAWL,SAASE,MADtB;AAEEI,uBAAWL,SAASC;AAFtB,WAFF;AAOA,gBAAKC,IAAL,CAAUF,SAASC,MAAnB;AACD;AACD,YAAIF,SAASO,IAAT,KAAkBN,SAASM,IAA/B,EAAqC;AACnC,gBAAKJ,IAAL,CACE,wBAAcK,UADhB,EAEE;AACEC,qBAAST,SAASO,IADpB;AAEEG,qBAAST,SAASM;AAFpB,WAFF;AAOD;AACD,YAAIN,SAASU,GAAT,IAAgB,CAACX,SAASW,GAA9B,EAAmC;AACjC,gBAAKR,IAAL,CAAU,wBAAcS,KAAxB;AACD;AACF;AACF,KAzBD;AAbmB;AAuCpB;;;;2BAsBM;AAAA;;AACL,WAAKrB,QAAQK,IAAb,EAAmBG,EAAnB,CAAsB,KAAKR,QAAQK,IAAb,EAAmBiB,UAAnB,CAA8BC,QAApD,6DAA8D;AAAA;AAAA;AAAA;AAAA;AAAA;AACtDH,mBADsD,IAC7C,OAAKI,MAAL,GAAiB,OAAKA,MAAtB,SAAkC,EADW,iBACE,OAAKxB,QAAQK,IAAb,EAAmBoB,OADrB;;AAE5D,uBAAKzB,QAAQM,OAAb,IAAwB,IAAI,OAAKN,QAAQO,eAAb,CAAJ,CAAkC,EAAEa,QAAF,EAAlC,CAAxB;;AAEIJ,oBAJwD,GAIjD,IAJiD;AAKxDU,qBALwD,GAKhD,IALgD;AAMxDf,sBANwD,GAM/C,wBAAcgB,KANiC;AAAA;AAAA;AAAA,uBAS7C,2DAAC;AAAA;AAAA;AAAA;AAAA;AAAA,2DAAY,OAAK3B,QAAQM,OAAb,EAAsBsB,OAAtB,EAAZ;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,iBAAD,IAT6C;;AAAA;AAS1DZ,oBAT0D;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAW1DL,yBAAS,wBAAckB,KAAvB;AACAH;;AAZ0D;;AAe5D,oBAAI,CAACV,IAAL,EAAWA,OAAO,EAAP;;AAEX,uBAAKc,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,OAAK7B,OAAL,CAAa8B,IADD;AAElBb,0BAFkB;AAGlBJ,4BAHkB;AAIlBU,8BAJkB;AAKlBf;AALkB,iBAApB;;AAQA,uBAAKX,QAAQkC,kBAAb,IAAmC,OAAKlC,QAAQM,OAAb,EAAsB6B,SAAtB,CAAgC,mBAAW;AAC5E,yBAAKL,KAAL,CAAWC,QAAX,CAAoB;AAClBC,0BAAM,OAAK7B,OAAL,CAAaiC,IADD;AAElBpB,0BAAMG;AAFY,mBAApB;AAID,iBALkC,CAAnC;;AAzB4D;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAA9D;AAgCA,WAAKnB,QAAQK,IAAb,EAAmBG,EAAnB,CAAsB,KAAKR,QAAQK,IAAb,EAAmBiB,UAAnB,CAA8Be,WAApD,EAAiE,YAAM;AACrE,YAAI,OAAK1B,MAAL,KAAgB,wBAAc2B,OAAlC,EAA2C;AACzC,iBAAKR,KAAL,CAAWC,QAAX,CAAoB;AAClBC,kBAAM,OAAK7B,OAAL,CAAaoC;AADD,WAApB;AAGA,iBAAKvC,QAAQkC,kBAAb;AACA,iBAAKlC,QAAQM,OAAb,EAAsBkC,OAAtB;AACA,iBAAKxC,QAAQM,OAAb,IAAwB,IAAxB;AACD;AACF,OATD;AAUD;;;;+FAGac,G,EAAKqB,K;;;;;;uBACX,KAAKC,OAAL,mCACHtB,GADG,EACGqB,KADH,E;;;;;;;;;;;;;;;;;;;+FAMMzB,I;;;;;;;;sBACR,CAAC,KAAK2B,KAAN,IAAe,KAAKA,KAAL,CAAWhC,MAAX,KAAsB,wBAAc2B,O;;;;;sBAC/C,IAAIM,KAAJ,CAAU,sBAAV,C;;;AAER,qBAAKd,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,KAAK7B,OAAL,CAAa0C,MADD;AAElB7B;AAFkB,iBAApB;AAIM8B,uB,GAAU,KAAKH,KAAL,CAAWG,O;;;AAEzB,qBAAKhB,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,KAAK7B,OAAL,CAAa4C;AADD,iBAApB;;uBAGK,2DACH;AAAA;AAAA;AAAA;AAAA;AAAA,4DAAY,OAAK/C,QAAQM,OAAb,EAAsBoC,OAAtB,CAA8B,OAAKd,OAAL,EAA9B,CAAZ;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,iBADG,I;;;AAGL,qBAAKE,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,KAAK7B,OAAL,CAAa6C,WADD;AAElBF;AAFkB,iBAApB;;;;;;;;AAKA,qBAAKhB,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,KAAK7B,OAAL,CAAa8C,SADD;AAElBH,kCAFkB;AAGlBpB;AAHkB,iBAApB;;;;;;;;;;;;;;;;;;;+FASaN,G;;;;;;;;sBACX,CAAC,KAAKuB,KAAN,IAAe,KAAKA,KAAL,CAAWhC,MAAX,KAAsB,wBAAc2B,O;;;;;sBAC/C,IAAIM,KAAJ,CAAU,sBAAV,C;;;AAER,qBAAKd,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,KAAK7B,OAAL,CAAa+C,MADD;AAElB9B;AAFkB,iBAApB;AAIM0B,uB,GAAU,KAAKH,KAAL,CAAWG,O;;;AAEzB,qBAAKhB,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,KAAK7B,OAAL,CAAa4C;AADD,iBAApB;;uBAGK,2DACH;AAAA;AAAA;AAAA;AAAA;AAAA,4DAAY,OAAK/C,QAAQM,OAAb,EAAsBoC,OAAtB,CAA8B,OAAKd,OAAL,EAA9B,CAAZ;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,iBADG,I;;;AAGL,qBAAKE,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,KAAK7B,OAAL,CAAa6C,WADD;AAElBF;AAFkB,iBAApB;;;;;;;;AAKA,qBAAKhB,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,KAAK7B,OAAL,CAAa8C,SADD;AAElBH,kCAFkB;AAGlBpB;AAHkB,iBAApB;;;;;;;;;;;;;;;;;;4BAQIN,G,EAAK;AACX,aAAO,KAAKuB,KAAL,CAAW3B,IAAX,CAAgBI,GAAhB,CAAP;AACD;;;8BAES;AACR,wCACK,KAAKuB,KAAL,CAAW3B,IADhB;AAGD;;;wBA7Ia;AACZ,aAAO,iCAAkB,KAAKQ,MAAvB,CAAP;AACD;;;wBAES;AACR,aAAO,KAAKmB,KAAL,CAAWvB,GAAlB;AACD;;;wBAEY;AACX,aAAO,KAAKuB,KAAL,CAAWhC,MAAlB;AACD;;;wBAEmB;AAClB;AACD;;;wBAEmB;AAClB;AACD;;;;kBA3DkBV,O","file":"index.js","sourcesContent":["import SymbolMap from 'data-types/symbol-map';\nimport RcModule, { initFunction } from '../../lib/RcModule';\nimport { proxify } from '../../lib/proxy';\nimport NamedStorage from '../../lib/NamedStorage';\nimport getStorageReducer from './getStorageReducer';\nimport storageActions from './storageActions';\nimport storageStatus from './storageStatus';\nimport storageEvents from './storageEvents';\n\nconst symbols = new SymbolMap([\n  'storage',\n  'storageProvider',\n  'unsubscribeStorage',\n]);\n\nexport default class Storage extends RcModule {\n  constructor(options) {\n    super({\n      ...options,\n      actions: storageActions,\n    });\n    const {\n      StorageProvider = NamedStorage,\n      auth,\n    } = options;\n    this[symbols.storage] = null;\n    this[symbols.storageProvider] = StorageProvider;\n    this[symbols.auth] = auth;\n\n    this.on('state-change', ({ oldState, newState }) => {\n      if (oldState) {\n        if (oldState.status !== newState.status) {\n          this.emit(\n            storageEvents.statusChange,\n            {\n              oldStatus: oldState.status,\n              newStatus: newState.status,\n            },\n          );\n          this.emit(newState.status);\n        }\n        if (oldState.data !== newState.data) {\n          this.emit(\n            storageEvents.dataChange,\n            {\n              oldData: oldState.data,\n              newData: newState.data,\n            },\n          );\n        }\n        if (newState.key && !oldState.key) {\n          this.emit(storageEvents.ready);\n        }\n      }\n    });\n  }\n  get reducer() {\n    return getStorageReducer(this.prefix);\n  }\n\n  get key() {\n    return this.state.key;\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get storageStatus() {\n    return storageStatus;\n  }\n\n  get storageEvents() {\n    return storageEvents;\n  }\n\n  @initFunction\n  init() {\n    this[symbols.auth].on(this[symbols.auth].authEvents.loggedIn, async () => {\n      const key = `${this.prefix ? `${this.prefix}-` : ''}storage-${this[symbols.auth].ownerId}`;\n      this[symbols.storage] = new this[symbols.storageProvider]({ key });\n\n      let data = null;\n      let error = null;\n      let status = storageStatus.saved;\n\n      try {\n        data = await (async () => this[symbols.storage].getData())();\n      } catch (e) {\n        status = storageStatus.dirty;\n        error = e;\n      }\n\n      if (!data) data = {};\n\n      this.store.dispatch({\n        type: this.actions.init,\n        key,\n        data,\n        error,\n        status,\n      });\n\n      this[symbols.unsubscribeStorage] = this[symbols.storage].subscribe(newData => {\n        this.store.dispatch({\n          type: this.actions.load,\n          data: newData,\n        });\n      });\n    });\n    this[symbols.auth].on(this[symbols.auth].authEvents.notLoggedIn, () => {\n      if (this.status !== storageStatus.pending) {\n        this.store.dispatch({\n          type: this.actions.reset,\n        });\n        this[symbols.unsubscribeStorage]();\n        this[symbols.storage].destroy();\n        this[symbols.storage] = null;\n      }\n    });\n  }\n\n  @proxify\n  async setItem(key, value) {\n    await this.setData({\n      [key]: value,\n    });\n  }\n\n  @proxify\n  async setData(data) {\n    if (!this.state || this.state.status === storageStatus.pending) {\n      throw new Error('Storage is not ready');\n    }\n    this.store.dispatch({\n      type: this.actions.update,\n      data,\n    });\n    const version = this.state.version;\n    try {\n      this.store.dispatch({\n        type: this.actions.save,\n      });\n      await(\n        async () => this[symbols.storage].setData(this.getData())\n      )();\n      this.store.dispatch({\n        type: this.actions.saveSuccess,\n        version,\n      });\n    } catch (error) {\n      this.store.dispatch({\n        type: this.actions.saveError,\n        version,\n        error,\n      });\n    }\n  }\n\n  @proxify\n  async removeItem(key) {\n    if (!this.state || this.state.status === storageStatus.pending) {\n      throw new Error('Storage is not ready');\n    }\n    this.store.dispatch({\n      type: this.actions.remove,\n      key,\n    });\n    const version = this.state.version;\n    try {\n      this.store.dispatch({\n        type: this.actions.save,\n      });\n      await(\n        async () => this[symbols.storage].setData(this.getData())\n      )();\n      this.store.dispatch({\n        type: this.actions.saveSuccess,\n        version,\n      });\n    } catch (error) {\n      this.store.dispatch({\n        type: this.actions.saveError,\n        version,\n        error,\n      });\n    }\n  }\n\n  getItem(key) {\n    return this.state.data[key];\n  }\n\n  getData() {\n    return {\n      ...this.state.data,\n    };\n  }\n}\n"]}