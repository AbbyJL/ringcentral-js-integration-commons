{"version":3,"sources":["modules/AccountContacts/index.js"],"names":["MaximumBatchGetPresence","DEFAULT_TTL","DEFAULT_PRESENCETTL","DEFAULT_AVATARTTL","DEFAULT_AVATARQUERYINTERVAL","AccountContacts","deps","dep","optional","client","accountExtension","accountPhoneNumber","ttl","avatarTtl","presenceTtl","avatarQueryInterval","options","actionTypes","_accountExtension","_accountPhoneNumber","_client","_ttl","_avatarTtl","_presenceTtl","_avatarQueryInterval","_reducer","addSelector","availableExtensions","extensionToPhoneNumberMap","profileImages","presences","extensions","newExtensions","forEach","extension","status","indexOf","type","id","contact","sourceName","firstName","lastName","email","extensionNumber","ext","hasProfileImage","phoneNumbers","profileImageUrl","imageUrl","presence","name","phones","length","phone","phoneNumber","push","store","subscribe","_onStateChange","_shouldInit","dispatch","initSuccess","_shouldReset","resetSuccess","ready","pending","useCache","resolve","imageId","Date","now","timestamp","image","_getAvatarContexts","_queryingAvatar","_processQueryAvatar","getAvatarContexts","ctx","account","profileImage","get","response","URL","_response","blob","createObjectURL","fetchImageSuccess","console","error","splice","presenceId","_getPresenceContexts","clearTimeout","enqueueTimeoutId","_processQueryPresences","setTimeout","getPresenceContexts","contacts","map","x","_batchQueryPresences","responses","presenceMap","dndStatus","presenceStatus","telephonyStatus","userStatus","batchFetchPresenceSuccess","presenceSet","ids","join","platform","service","url","multipartResponse","json","item","state","_selectors"],"mappings":"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","file":"index.js","sourcesContent":["import RcModule from '../../lib/RcModule';\nimport { Module } from '../../lib/di';\nimport isBlank from '../../lib/isBlank';\nimport ensureExist from '../../lib/ensureExist';\nimport { addPhoneToContact } from '../../lib/contactHelper';\nimport { batchGetApi } from '../../lib/batchApiHelper';\nimport proxify from '../../lib/proxy/proxify';\nimport sleep from '../../lib/sleep';\n\nimport actionTypes from './actionTypes';\nimport getReducer from './getReducer';\n\nconst MaximumBatchGetPresence = 30;\nconst DEFAULT_TTL = 30 * 60 * 1000; // 30 mins\nconst DEFAULT_PRESENCETTL = 10 * 60 * 1000; // 10 mins\nconst DEFAULT_AVATARTTL = 2 * 60 * 60 * 1000; // 2 hour\nconst DEFAULT_AVATARQUERYINTERVAL = 2 * 1000; // 2 seconds\n\n/**\n * @class\n * @description Contacts managing module\n */\n@Module({\n  deps: [\n    'Client',\n    'AccountExtension',\n    'AccountPhoneNumber',\n    { dep: 'AccoundContactsOptions', optional: true }\n  ]\n})\nexport default class AccountContacts extends RcModule {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {Client} params.client - client module instance\n   * @param {AccountExtension} params.accountExtension - accountExtension module instance\n   * @param {AccountPhoneNumber} params.accountPhoneNumber - accountPhoneNumber module instance\n   * @param {Number} params.ttl - timestamp of local cache, default 30 mins\n   * @param {Number} params.avatarTtl - timestamp of avatar local cache, default 2 hour\n   * @param {Number} params.presenceTtl - timestamp of presence local cache, default 10 mins\n   * @param {Number} params.avatarQueryInterval - interval of query avatar, default 2 seconds\n   */\n  constructor({\n    client,\n    accountExtension,\n    accountPhoneNumber,\n    ttl = DEFAULT_TTL,\n    avatarTtl = DEFAULT_AVATARTTL,\n    presenceTtl = DEFAULT_PRESENCETTL,\n    avatarQueryInterval = DEFAULT_AVATARQUERYINTERVAL,\n    ...options,\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._accountExtension = this::ensureExist(accountExtension, 'accountExtension');\n    this._accountPhoneNumber = this::ensureExist(accountPhoneNumber, 'accountPhoneNumber');\n    this._client = this::ensureExist(client, 'client');\n\n    this._ttl = ttl;\n    this._avatarTtl = avatarTtl;\n    this._presenceTtl = presenceTtl;\n    this._avatarQueryInterval = avatarQueryInterval;\n\n    this._reducer = getReducer(this.actionTypes);\n\n    this.addSelector(\n      'contacts',\n      () => this._accountExtension.availableExtensions,\n      () => this._accountPhoneNumber.extensionToPhoneNumberMap,\n      () => this.profileImages,\n      () => this.presences,\n      (extensions, extensionToPhoneNumberMap, profileImages, presences) => {\n        const newExtensions = [];\n        extensions.forEach((extension) => {\n          if (!(extension.status === 'Enabled' &&\n            ['DigitalUser', 'User', 'Department'].indexOf(extension.type) >= 0)) {\n            return;\n          }\n          const id = `${extension.id}`;\n          const contact = {\n            type: this.sourceName,\n            id,\n            firstName: extension.contact && extension.contact.firstName,\n            lastName: extension.contact && extension.contact.lastName,\n            email: extension.contact && extension.contact.email,\n            extensionNumber: extension.ext,\n            hasProfileImage: !!extension.hasProfileImage,\n            phoneNumbers: [],\n            profileImageUrl: profileImages[id] && profileImages[id].imageUrl,\n            presence: presences[id] && presences[id].presence,\n          };\n          contact.name = `${contact.firstName || ''} ${contact.lastName || ''}`;\n          if (isBlank(contact.extensionNumber)) {\n            return;\n          }\n          const phones = extensionToPhoneNumberMap[contact.extensionNumber];\n          if (phones && phones.length > 0) {\n            phones.forEach((phone) => {\n              addPhoneToContact(contact, phone.phoneNumber, 'directPhone');\n            });\n          }\n          newExtensions.push(contact);\n        });\n        return newExtensions;\n      }\n    );\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  _onStateChange() {\n    if (this._shouldInit()) {\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n    } else if (this._shouldReset()) {\n      this.store.dispatch({\n        type: this.actionTypes.resetSuccess,\n      });\n    }\n  }\n\n  _shouldInit() {\n    return (\n      this._accountExtension.ready &&\n      this._accountPhoneNumber.ready &&\n      this.pending\n    );\n  }\n\n  _shouldReset() {\n    return (\n      (\n        !this._accountExtension.ready ||\n        !this._accountPhoneNumber.ready\n      ) &&\n      this.ready\n    );\n  }\n\n  // interface of contact source\n  @proxify\n  getProfileImage(contact, useCache = true) {\n    return new Promise((resolve) => {\n      if (!contact || !contact.id || contact.type !== 'company' || !contact.hasProfileImage) {\n        resolve(null);\n        return;\n      }\n\n      const imageId = contact.id;\n      if (\n        useCache &&\n        this.profileImages[imageId] &&\n        (Date.now() - this.profileImages[imageId].timestamp < this._avatarTtl)\n      ) {\n        const image = this.profileImages[imageId].imageUrl;\n        resolve(image);\n        return;\n      }\n\n      if (!this._getAvatarContexts) {\n        this._getAvatarContexts = [];\n      }\n      this._getAvatarContexts.push({\n        contact,\n        resolve,\n      });\n\n      if (!this._queryingAvatar) {\n        this._queryingAvatar = true;\n        this._processQueryAvatar(this._getAvatarContexts);\n      }\n    });\n  }\n\n  async _processQueryAvatar(getAvatarContexts) {\n    const ctx = getAvatarContexts[0];\n    const imageId = `${ctx.contact.id}`;\n    let imageUrl = null;\n    try {\n      const response = await this._client\n        .account()\n        .extension(ctx.contact.id)\n        .profileImage('195x195')\n        .get();\n      imageUrl = URL.createObjectURL(await response._response.blob());\n      this.store.dispatch({\n        type: this.actionTypes.fetchImageSuccess,\n        imageId,\n        imageUrl,\n        ttl: this._avatarTtl,\n      });\n    } catch (e) {\n      console.error(e);\n    }\n    ctx.resolve(imageUrl);\n    getAvatarContexts.splice(0, 1);\n    if (getAvatarContexts.length) {\n      await sleep(this._avatarQueryInterval);\n      this._processQueryAvatar(getAvatarContexts);\n    } else {\n      this._queryingAvatar = false;\n    }\n  }\n\n  // interface of contact source\n  @proxify\n  getPresence(contact) {\n    return new Promise((resolve) => {\n      if (!contact || !contact.id || contact.type !== 'company') {\n        resolve(null);\n        return;\n      }\n\n      const presenceId = `${contact.id}`;\n      if (\n        this.presences[presenceId] &&\n        (Date.now() - this.presences[presenceId].timestamp < this._presenceTtl)\n      ) {\n        const presence = this.presences[presenceId].presence;\n        resolve(presence);\n        return;\n      }\n\n      if (!this._getPresenceContexts) {\n        this._getPresenceContexts = [];\n      }\n      this._getPresenceContexts.push({\n        contact,\n        resolve,\n      });\n\n      clearTimeout(this.enqueueTimeoutId);\n      if (this._getPresenceContexts.length === MaximumBatchGetPresence) {\n        this._processQueryPresences(this._getPresenceContexts);\n        this._getPresenceContexts = null;\n      } else {\n        this.enqueueTimeoutId = setTimeout(() => {\n          this._processQueryPresences(this._getPresenceContexts);\n          this._getPresenceContexts = null;\n        }, 1000);\n      }\n    });\n  }\n\n  async _processQueryPresences(getPresenceContexts) {\n    const contacts = getPresenceContexts.map(x => x.contact);\n    const responses = await this._batchQueryPresences(contacts);\n    const presenceMap = {};\n    getPresenceContexts.forEach((ctx) => {\n      const response = responses[ctx.contact.id];\n      if (!response) {\n        ctx.resolve(null);\n        return;\n      }\n      const { dndStatus, presenceStatus, telephonyStatus, userStatus } = response;\n      const presenceId = ctx.contact.id;\n      presenceMap[presenceId] = {\n        dndStatus,\n        presenceStatus,\n        telephonyStatus,\n        userStatus,\n      };\n      ctx.resolve(presenceMap[presenceId]);\n    });\n    this.store.dispatch({\n      type: this.actionTypes.batchFetchPresenceSuccess,\n      presenceMap,\n      ttl: this._presenceTtl,\n    });\n  }\n\n  async _batchQueryPresences(contacts) {\n    const presenceSet = {};\n    try {\n      if (contacts.length === 1) {\n        const id = contacts[0].id;\n        const response = await this._client.account().extension(id).presence().get();\n        presenceSet[id] = response;\n      } else if (contacts.length > 1) {\n        const ids = contacts.map(x => x.id).join(',');\n        const multipartResponse = await batchGetApi({\n          platform: this._client.service.platform(),\n          url: `/account/~/extension/${ids}/presence?detailedTelephonyState=true&sipData=true`,\n        });\n        const responses = multipartResponse.map(x => x.json());\n        responses.forEach((item) => {\n          presenceSet[item.extension.id] = item;\n        });\n      }\n    } catch (e) {\n      console.error(e);\n    }\n    return presenceSet;\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get profileImages() {\n    return this.state.profileImages;\n  }\n\n  get presences() {\n    return this.state.presences;\n  }\n\n  // interface of contact source\n  get sourceName() {\n    return 'company';\n  }\n\n  // interface of contact source\n  get contacts() {\n    return this._selectors.contacts();\n  }\n}\n"]}