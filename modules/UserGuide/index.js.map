{"version":3,"sources":["modules/UserGuide/index.js"],"names":["UserGuide","deps","dep","optional","auth","storage","webphone","rolesAndPermissions","options","actionTypes","_auth","_storage","_webphone","_rolesAndPermissions","_reducer","_context","context","_storageKey","_guideReducer","registerReducer","key","reducer","store","subscribe","_onStateChange","pending","ready","loggedIn","dispatch","type","initSuccess","initUserGuide","resetSuccess","ringSession","_lastRingSession","updateCarousel","curIdx","entered","playing","keys","sort","map","guides","loadGuides","hasUserGuidePermission","prevGuides","resolveGuides","length","getItem","Array","isArray","state","carouselState","status"],"mappings":"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","file":"index.js","sourcesContent":["import RcModule from '../../lib/RcModule';\nimport proxify from '../../lib/proxy/proxify';\nimport { Module } from '../../lib/di';\nimport actionTypes from './actionTypes';\nimport getUserGuideReducer, { getGuidesReducer } from './getUserGuideReducer';\n\n@Module({\n  deps: [\n    'Auth',\n    'Storage',\n    'Webphone',\n    'RolesAndPermissions',\n    { dep: 'UserGuideOptions', optional: true }\n  ]\n})\nexport default class UserGuide extends RcModule {\n  constructor({\n    auth,\n    storage,\n    webphone,\n    rolesAndPermissions,\n    ...options\n  }) {\n    super({\n      actionTypes,\n      ...options\n    });\n    this._auth = auth;\n    this._storage = storage;\n    this._webphone = webphone;\n    this._rolesAndPermissions = rolesAndPermissions;\n    this._reducer = getUserGuideReducer(this.actionTypes);\n\n    this._context = options.context;\n\n    this._storageKey = 'userGuide';\n    this._guideReducer = getGuidesReducer(this.actionTypes);\n    this._storage.registerReducer({\n      key: this._storageKey,\n      reducer: this._guideReducer,\n    });\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  async _onStateChange() {\n    if (\n      this.pending &&\n      this._auth.ready &&\n      this._storage.ready &&\n      this._rolesAndPermissions.ready &&\n      this._auth.loggedIn\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n      await this.initUserGuide();\n    } else if (\n      this.ready && (\n        !this._auth.ready ||\n        !this._storage.ready ||\n        !this._rolesAndPermissions.ready\n      )) {\n      this.store.dispatch({\n        type: this.actionTypes.resetSuccess\n      });\n    }\n    // When there is an incoming call,\n    // the guide should be dismissed\n    if (\n      this._webphone.ready &&\n      this._webphone.ringSession &&\n      this._webphone.ringSession !== this._lastRingSession\n    ) {\n      this._lastRingSession = this._webphone.ringSession;\n      this.updateCarousel({ curIdx: 0, entered: false, playing: false });\n    }\n  }\n\n  /**\n   * Using webpack `require.context` to load guides files.\n   * Image files will be ordered by file name ascendingly.\n   */\n  resolveGuides() {\n    if (this._context && typeof this._context === 'function') {\n      return this._context.keys().sort().map(key => this._context(key));\n    }\n    return [];\n  }\n\n  @proxify\n  async loadGuides(guides) {\n    if (guides) {\n      this.store.dispatch({\n        type: this.actionTypes.loadGuides,\n        guides\n      });\n    }\n  }\n\n  @proxify\n  async updateCarousel({ curIdx, entered, playing }) {\n    this.store.dispatch({\n      type: this.actionTypes.updateCarousel,\n      curIdx,\n      entered,\n      playing\n    });\n  }\n\n  @proxify\n  async initUserGuide() {\n    if (!this._rolesAndPermissions.hasUserGuidePermission) return;\n    // eslint-disable-next-line\n    const prevGuides = this.guides;\n    const guides = this.resolveGuides();\n    // Determine if it needs to be displayed when first log in,\n    // the principles behind this is to use webpack's file hash,\n    // i.e. if any of the guide files is changed, the file name hash\n    // will be changed as well, in this case, it will be displayed.\n    await this.loadGuides(guides);\n    // if (JSON.stringify(guides) !== JSON.stringify(prevGuides)) {\n    //   await this.start();\n    // }\n  }\n\n  @proxify\n  async start() {\n    // Start guides only when images are ready\n    if (this.guides.length > 0) {\n      this.store.dispatch({\n        type: this.actionTypes.updateCarousel,\n        curIdx: 0,\n        entered: true,\n        playing: true,\n      });\n    }\n  }\n\n  get guides() {\n    if (!this._storage.ready) return [];\n    const guides = this._storage.getItem(this._storageKey);\n    if (guides && Array.isArray(guides)) return guides;\n    return [];\n  }\n\n  get carouselState() {\n    return this.state.carouselState;\n  }\n\n  get started() {\n    return this.carouselState.entered && this.carouselState.playing;\n  }\n\n  get status() {\n    return this.state.status;\n  }\n}\n"]}