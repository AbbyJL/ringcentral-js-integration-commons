{"version":3,"sources":["modules/user/index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import RcModule from '../../lib/rc-module';\nimport SymbolMap from 'data-types/symbol-map';\nimport { extractData, fetchList, emit } from '../../lib/utils';\nimport userActions from './user-actions';\nimport getUserReducer from './user-reducer';\nimport { userEvents, userEventTypes } from './user-events';\n\nconst symbols = new SymbolMap([\n  'api',\n  'platform',\n  'settings',\n]);\n\n// const initialState = {\n//   test: true,\n// };\n\n// function getUserSettingsReducer(prefix) {\n//   return (state, action) => {\n//     if (typeof state === 'undefined') return Object.assign({}, initialState);\n//     if (!action) return state;\n//     switch (action.type) {\n//       default:\n//         return state;\n//     }\n//   };\n// }\n\n/**\n * @function\n * @param {String} dataType\n * @param {function} loadFunction - async loader function returning a promise\n * @return {Promise}\n * @description Generic data loading logic with events\n */\nasync function loadData(dataType, loadFunction) {\n  this.store.dispatch({\n    type: this.actions[`load${dataType}`],\n  });\n  this.emit(userEvents[`load${dataType}`]);\n  try {\n    const payload = await this::loadFunction();\n    this.store.dispatch({\n      type: this.actions[`load${dataType}Success`],\n      payload,\n    });\n    this::emit(userEventTypes.userInfoChanged, userEvents[`load${dataType}Success`]);\n  } catch (error) {\n    this.store.dispatch({\n      type: this.actions[`load${dataType}Failed`],\n    });\n    this.emit(userEvents[`load${dataType}Failed`]);\n    throw error;\n  }\n}\n\n/**\n * @function\n * @return {Promise<Object>}\n * @description Fetch account info and extract the data\n */\nasync function extractAccountInfo() {\n  return extractData(await this[symbols.api].account().get());\n}\nasync function loadAccountInfo() {\n  return await this::loadData('AccountInfo', extractAccountInfo);\n}\n\nasync function extractExtensionInfo() {\n  return extractData(await this[symbols.api].account().extension().get());\n}\nasync function loadExtensionInfo() {\n  return await this::loadData('ExtensionInfo', extractExtensionInfo);\n}\n\nasync function extractDialingPlans() {\n  // TODO: js-client have dialing-plan?\n  return extractData(await this::fetchList(options => (\n    this[symbols.api].account().listDialingPlans(options)\n  )));\n}\nasync function loadDialingPlans() {\n  return await this::loadData('DialingPlans', extractDialingPlans);\n}\n\nasync function extractPhoneNumbers() {\n  return extractData(await this::fetchList(options => (\n    this[symbols.api].account().extension().phoneNumber().list(options)\n  )));\n}\nasync function loadPhoneNumbers() {\n  return await this::loadData('PhoneNumbers', extractPhoneNumbers);\n}\n\nasync function extractForwardingNumbers() {\n  return extractData(await this::fetchList(options => (\n    this[symbols.api].account().extension().forwardingNumber().list()\n  )));\n}\nasync function loadForwardingNumbers() {\n  return await this::loadData('ForwardingNumbers', extractForwardingNumbers);\n}\n\nasync function extractBlockedNumbers() {\n  return extractData(await this::fetchList(options => (\n    this[symbols.api].account().extension().blockedNumber().list(options)\n  )));\n}\nasync function loadBlockedNumbers() {\n  return await this::loadData('BlockedNumbers', extractBlockedNumbers);\n}\n\n/**\n * @function\n * @return {Promise}\n */\nasync function loadInfo() {\n  try {\n    await Promise.all([\n      this::loadAccountInfo(),\n      this::loadExtensionInfo(),\n      // this::loadDialingPlans(),\n      this::loadPhoneNumbers(),\n      this::loadForwardingNumbers(),\n      this::loadBlockedNumbers(),\n    ]);\n    // this.emit(userEvents.userInfoLoaded);\n  } catch (e) {\n    // TODO send error out\n    console.error(e);\n  }\n}\n\n/**\n * @class User\n * @extends RcModule\n * @default\n * @export\n */\nexport default class User extends RcModule {\n  /**\n   * @function\n   * @param {Object} options\n   */\n  constructor(options) {\n    super({\n      ...options,\n      actions: userActions,\n    });\n    const {\n      api,\n      platform,\n      settings,\n    } = options;\n    this[symbols.api] = api;\n    this[symbols.platform] = platform;\n    this[symbols.settings] = settings;\n\n    // settings.registerReducer('user', getUserSettingsReducer());\n\n    // load info on login\n    platform.on(platform.events.loginSuccess, () => {\n      this::loadInfo();\n    });\n    // unload info on logout\n    platform.on(platform.events.logoutSuccess, () => {\n      this.store.dispatch({\n        type: this.actions.clearUserInfo,\n      });\n      // this.emit(userEvents.userInfoCleared);\n    });\n\n\n    // load info if already logged in\n    (async () => {\n      if (await platform.loggedIn()) {\n        await this::loadInfo();\n      }\n    })();\n\n    /**\n     * TODO:\n     *   1. Dialing Plan Checking\n     */\n  }\n  get reducer() {\n    return getUserReducer(this.prefix);\n  }\n\n  get events() {\n    return userEvents;\n  }\n\n  get eventTypes() {\n    return userEventTypes;\n  }\n\n  get directNumbers() {\n    return this.state.phoneNumbers.filter(n => n.usageType === 'DirectNumber');\n  }\n\n  get mainCompanyNumber() {\n    return this.state.phoneNumbers.find(n => n.usageType === 'MainCompanyNumber');\n  }\n\n  get dialingPlans() {\n    return this.state.dialingPlans;\n  }\n\n  get extensionNumber() {\n    return this.state.extensionInfo.extensionNumber;\n  }\n\n  get smsNumbers() {\n    return this.state.phoneNumbers.filter(n => n.features.indexOf('SmsSender') > -1);\n  }\n\n}\n"]}