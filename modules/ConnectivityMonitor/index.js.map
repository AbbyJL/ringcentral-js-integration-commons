{"version":3,"sources":["modules/ConnectivityMonitor/index.js"],"names":["DEFAULT_TIME_TO_RETRY","ConnectivityMonitor","alert","client","environment","timeToRetry","options","actionTypes","_requestSuccessHandler","connectivity","store","dispatch","type","connectSuccess","_clearTimeout","_requestErrorHandler","apiResponse","Error","message","connectFail","showAlert","_retry","_alert","_client","_environment","_timeToRetry","_reducer","_timeoutId","subscribe","ready","_bindHandlers","initSuccess","changed","danger","disconnected","ttl","allowDuplicates","_unbindHandlers","service","platform","on","events","requestSuccess","requestError","off","get","skipAuthCheck","clearTimeout","t","setTimeout","_checkConnection","state","status"],"mappings":"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","file":"index.js","sourcesContent":["import RcModule from '../../lib/RcModule';\nimport actionTypes from './actionTypes';\nimport moduleStatus from '../../enums/moduleStatus';\nimport getConnectivityMonitorReducer from './getConnectivityMonitorReducer';\nimport connectivityMonitorMessages from './connectivityMonitorMessages';\n\nconst DEFAULT_TIME_TO_RETRY = 5000;\n\nexport default class ConnectivityMonitor extends RcModule {\n  constructor({\n    alert,\n    client,\n    environment,\n    timeToRetry = DEFAULT_TIME_TO_RETRY,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._alert = alert;\n    this._client = client;\n    this._environment = environment;\n    this._timeToRetry = timeToRetry;\n    this._reducer = getConnectivityMonitorReducer(this.actionTypes);\n    this._timeoutId = null;\n  }\n  initialize() {\n    this.store.subscribe(async () => {\n      if (\n        !this.ready &&\n        (!this._environment || this._environment.ready)\n      ) {\n        this._bindHandlers();\n        this.store.dispatch({\n          type: this.actionTypes.initSuccess,\n        });\n      } else if (\n        this.ready &&\n        this._environment && this._environment.changed\n      ) {\n        this._bindHandlers();\n      }\n    });\n  }\n  _requestSuccessHandler = () => {\n    if (!this.connectivity) {\n      this.store.dispatch({\n        type: this.actionTypes.connectSuccess,\n      });\n    }\n    this._clearTimeout();\n  }\n  showAlert() {\n    if (!this.connectivity && this._alert) {\n      this._alert.danger({\n        message: connectivityMonitorMessages.disconnected,\n        ttl: 0,\n        allowDuplicates: false,\n      });\n    }\n  }\n  _requestErrorHandler = (apiResponse) => {\n    if (\n      apiResponse instanceof Error &&\n      apiResponse.message === 'Failed to fetch'\n    ) {\n      if (this.connectivity) {\n        this.store.dispatch({\n          type: this.actionTypes.connectFail,\n        });\n        this.showAlert();\n      }\n      this._retry();\n    }\n  }\n  _bindHandlers() {\n    if (this._unbindHandlers) {\n      this._unbindHandlers();\n    }\n    const client = this._client.service.platform().client();\n    client.on(client.events.requestSuccess, this._requestSuccessHandler);\n    client.on(client.events.requestError, this._requestErrorHandler);\n    this._unbindHandlers = () => {\n      client.off(client.events.requestSuccess, this._requestSuccessHandler);\n      client.off(client.events.requestError, this._requestErrorHandler);\n      this._unbindHandlers = null;\n    };\n  }\n\n  async _checkConnection() {\n    try {\n      // query api info as a test of connectivity\n      await this._client.service.platform().get('', null, { skipAuthCheck: true });\n    } catch (error) {\n      /* falls through */\n    }\n  }\n  _clearTimeout() {\n    if (this._timeoutId) clearTimeout(this._timeoutId);\n  }\n  _retry(t = this._timeToRetry) {\n    this._clearTimeout();\n    this._timeoutId = setTimeout(() => {\n      this._timeoutId = null;\n      this._checkConnection();\n    }, t);\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatus.ready;\n  }\n\n  get connectivity() {\n    return this.state.connectivity;\n  }\n}\n"]}