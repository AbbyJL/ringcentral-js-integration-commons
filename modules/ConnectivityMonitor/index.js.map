{"version":3,"sources":["modules/ConnectivityMonitor/index.js"],"names":["DEFAULT_TIME_TO_RETRY","ConnectivityMonitor","alert","client","environment","timeToRetry","options","actionTypes","_requestSuccessHandler","connectivity","store","dispatch","type","connectSuccess","_clearTimeout","_requestErrorHandler","apiResponse","Error","message","connectFail","_alert","danger","disconnected","ttl","allowDuplicates","_retry","_client","_environment","_timeToRetry","_reducer","_timeoutId","subscribe","ready","_bindHandlers","initSuccess","changed","_unbindHandlers","service","platform","on","events","requestSuccess","requestError","off","get","skipAuthCheck","clearTimeout","t","setTimeout","_checkConnection","state","status"],"mappings":"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","file":"index.js","sourcesContent":["import RcModule from '../../lib/RcModule';\nimport actionTypes from './actionTypes';\nimport moduleStatus from '../../enums/moduleStatus';\nimport getConnectivityMonitorReducer from './getConnectivityMonitorReducer';\nimport connectivityMonitorMessages from './connectivityMonitorMessages';\n\nconst DEFAULT_TIME_TO_RETRY = 5000;\n\nexport default class ConnectivityMonitor extends RcModule {\n  constructor({\n    alert,\n    client,\n    environment,\n    timeToRetry = DEFAULT_TIME_TO_RETRY,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._alert = alert;\n    this._client = client;\n    this._environment = environment;\n    this._timeToRetry = timeToRetry;\n    this._reducer = getConnectivityMonitorReducer(this.actionTypes);\n    this._timeoutId = null;\n  }\n  initialize() {\n    this.store.subscribe(async () => {\n      if (\n        !this.ready &&\n        (!this._environment || this._environment.ready)\n      ) {\n        this._bindHandlers();\n        this.store.dispatch({\n          type: this.actionTypes.initSuccess,\n        });\n      } else if (\n        this.ready &&\n        this._environment && this._environment.changed\n      ) {\n        this._bindHandlers();\n      }\n    });\n  }\n  _requestSuccessHandler = () => {\n    if (!this.connectivity) {\n      this.store.dispatch({\n        type: this.actionTypes.connectSuccess,\n      });\n    }\n    this._clearTimeout();\n  }\n  _requestErrorHandler = (apiResponse) => {\n    if (\n      apiResponse instanceof Error &&\n      apiResponse.message === 'Failed to fetch'\n    ) {\n      if (this.connectivity) {\n        this.store.dispatch({\n          type: this.actionTypes.connectFail,\n        });\n        if (this._alert) {\n          this._alert.danger({\n            message: connectivityMonitorMessages.disconnected,\n            ttl: 0,\n            allowDuplicates: false,\n          });\n        }\n      }\n      this._retry();\n    }\n  }\n  _bindHandlers() {\n    if (this._unbindHandlers) {\n      this._unbindHandlers();\n    }\n    const client = this._client.service.platform().client();\n    client.on(client.events.requestSuccess, this._requestSuccessHandler);\n    client.on(client.events.requestError, this._requestErrorHandler);\n    this._unbindHandlers = () => {\n      client.off(client.events.requestSuccess, this._requestSuccessHandler);\n      client.off(client.events.requestError, this._requestErrorHandler);\n      this._unbindHandlers = null;\n    };\n  }\n\n  async _checkConnection() {\n    try {\n      // query api info as a test of connectivity\n      await this._client.service.platform().get('', null, { skipAuthCheck: true });\n    } catch (error) {\n      /* falls through */\n    }\n  }\n  _clearTimeout() {\n    if (this._timeoutId) clearTimeout(this._timeoutId);\n  }\n  _retry(t = this._timeToRetry) {\n    this._clearTimeout();\n    this._timeoutId = setTimeout(() => {\n      this._timeoutId = null;\n      this._checkConnection();\n    }, t);\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatus.ready;\n  }\n\n  get connectivity() {\n    return this.state.connectivity;\n  }\n}\n"]}