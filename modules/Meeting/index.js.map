{"version":3,"sources":["modules/Meeting/index.js"],"names":["UTC_TIMEZONE_ID","MeetingType","SCHEDULED","RECURRING","INSTANT","getDefaultMeetingSettings","topic","extensionName","meetingType","password","schedule","startTime","Date","getTime","durationInMinutes","timeZone","id","host","allowJoinBeforeHost","startHostVideo","startParticipantsVideo","audioOptions","_requireMeetingPassword","_showDate","_showTime","MeetingErrors","type","_errors","push","message","length","Meeting","deps","dep","optional","alert","client","extensionInfo","storage","options","actionTypes","_alert","_client","_extensionInfo","_storage","_reducer","_lastMeetingSettingKey","registerReducer","key","reducer","store","subscribe","_onStateChange","_shouldInit","_init","_shouldReset","_reset","ready","pending","dispatch","initSuccess","resetSuccess","_initMeeting","info","name","updateMeeting","meeting","lastMeetingInfo","isScheduling","initScheduling","_validate","_format","account","extension","post","resp","serviceInfo","get","scheduled","setTimeout","scheduledSuccess","resetScheduling","all","error","warning","rest","formatted","_schedule","utc","format","invalidMeetingInfo","errors","emptyTopic","noPassword","durationIncorrect","state","getItem","schedulingStatus","scheduling","status"],"mappings":"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","file":"index.js","sourcesContent":["import moment from 'moment';\nimport RcModule from '../../lib/RcModule';\nimport { Module } from '../../lib/di';\nimport proxify from '../../lib/proxy/proxify';\nimport background from '../../lib/background';\nimport actionTypes from './actionTypes';\nimport scheduleStatus from './scheduleStatus';\nimport meetingStatus from './meetingStatus';\nimport getMeetingReducer, { getMeetingStorageReducer } from './getMeetingReducer';\n\nexport const UTC_TIMEZONE_ID = '1';\nexport const MeetingType = {\n  SCHEDULED: 'Scheduled',\n  RECURRING: 'Recurring',\n  INSTANT: 'Instant',\n};\n\n// Basic default meeting type information\nexport const getDefaultMeetingSettings = extensionName => ({\n  topic: `${extensionName}'s Meeting`,\n  meetingType: MeetingType.SCHEDULED,\n  password: null,\n  schedule: {\n    startTime: (new Date()).getTime(),\n    durationInMinutes: 60,\n    timeZone: {\n      id: UTC_TIMEZONE_ID\n    }\n  },\n  host: {\n    id: null,\n  },\n  allowJoinBeforeHost: false,\n  startHostVideo: false,\n  startParticipantsVideo: false,\n  audioOptions: ['Phone', 'ComputerAudio'],\n  _requireMeetingPassword: false,\n  _showDate: false,\n  _showTime: false,\n});\n\nclass MeetingErrors {\n  constructor(type) {\n    this._errors = [];\n    if (type) this._errors.push({ message: type });\n  }\n\n  push(type) {\n    if (type) this._errors.push({ message: type });\n  }\n\n  get all() {\n    return this._errors;\n  }\n\n  get length() {\n    return this._errors.length;\n  }\n}\n\n@Module({\n  deps: [\n    'Alert',\n    'Client',\n    'ExtensionInfo',\n    'Storage',\n    { dep: 'MeetingOptions', optional: true }\n  ]\n})\nexport default class Meeting extends RcModule {\n  constructor({\n    alert,\n    client,\n    extensionInfo,\n    storage,\n    ...options\n  }) {\n    super({ ...options, actionTypes });\n    this._alert = alert;\n    this._client = client;\n    this._extensionInfo = extensionInfo;\n    this._storage = storage;\n    this._reducer = getMeetingReducer(this.actionTypes);\n    this._lastMeetingSettingKey = 'lastMeetingSetting';\n    this._storage.registerReducer({\n      key: this._lastMeetingSettingKey,\n      reducer: getMeetingStorageReducer(this.actionTypes)\n    });\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  _onStateChange() {\n    if (this._shouldInit()) {\n      this._init();\n    } else if (this._shouldReset()) {\n      this._reset();\n    }\n  }\n\n  _shouldInit() {\n    return (\n      this._alert.ready &&\n      this._storage.ready &&\n      this._extensionInfo.ready &&\n      this.pending\n    );\n  }\n\n  _init() {\n    this.store.dispatch({\n      type: this.actionTypes.initSuccess\n    });\n  }\n\n  _shouldReset() {\n    return (\n      (\n        !this._alert.ready ||\n        !this._storage.ready ||\n        !this._extensionInfo.ready\n      ) &&\n      this.ready\n    );\n  }\n\n  _reset() {\n    this.store.dispatch({\n      type: this.actionTypes.resetSuccess\n    });\n  }\n\n  /**\n   * Init basic meeting information\n   * also load meeting settings from previous one.\n   */\n  @background\n  init() {\n    this._initMeeting();\n  }\n\n  @proxify\n  reload() {\n    this._initMeeting();\n  }\n\n  _initMeeting() {\n    const extensionName = this._extensionInfo.info.name || '';\n    this.store.dispatch({\n      type: this.actionTypes.updateMeeting,\n      meeting: {\n        ...getDefaultMeetingSettings(extensionName),\n        // Load last meeting settings\n        ...this.lastMeetingInfo\n      }\n    });\n  }\n\n  @proxify\n  update(meeting) {\n    this.store.dispatch({\n      type: this.actionTypes.updateMeeting,\n      meeting\n    });\n  }\n\n  @proxify\n  async schedule(meeting) {\n    if (this.isScheduling) return null;\n    meeting = meeting || this.meeting;\n    try {\n      this.store.dispatch({\n        type: this.actionTypes.initScheduling\n      });\n      // Validate meeting\n      this._validate(meeting);\n      meeting = this._format(meeting);\n\n      const resp = await this._client\n        .account()\n        .extension()\n        .meeting()\n        .post(meeting);\n      const serviceInfo = await this._client\n        .account()\n        .extension()\n        .meeting()\n        .serviceInfo()\n        .get();\n      this.store.dispatch({\n        type: this.actionTypes.scheduled,\n        meeting\n      });\n      // Reload meeting info\n      this._initMeeting();\n      // Nofity user the meeting has been scheduled\n      setTimeout(() => {\n        this._alert.info({\n          message: meetingStatus.scheduledSuccess\n        });\n      }, 50);\n      return {\n        meeting: resp,\n        serviceInfo,\n        extensionInfo: this.extensionInfo\n      };\n    } catch (errors) {\n      this.store.dispatch({\n        type: this.actionTypes.resetScheduling\n      });\n      if (errors instanceof MeetingErrors) {\n        for (const error of errors.all) {\n          this._alert.warning(error);\n        }\n      }\n      return null;\n    }\n  }\n\n  /**\n   * Format meeting infomation.\n   * @param {Object} meeting\n   */\n  _format(meeting) {\n    const {\n      topic,\n      meetingType,\n      allowJoinBeforeHost,\n      startHostVideo,\n      startParticipantsVideo,\n      audioOptions,\n      password,\n      schedule,\n      ...rest,\n    } = meeting;\n    const formatted = {\n      topic,\n      meetingType,\n      allowJoinBeforeHost,\n      startHostVideo,\n      startParticipantsVideo,\n      audioOptions,\n      ...rest,\n    };\n    if (password) {\n      formatted.password = password;\n    }\n    // Recurring meetings do not have schedule info\n    if (meetingType !== MeetingType.RECURRING) {\n      const _schedule = {\n        durationInMinutes: schedule.durationInMinutes,\n        timeZone: { id: UTC_TIMEZONE_ID }\n      };\n      if (schedule.startTime) {\n        // Format selected startTime to utc standard time\n        // Timezone infomation is not included here\n        _schedule.startTime = moment.utc(schedule.startTime).format();\n      }\n      formatted.schedule = _schedule;\n    }\n    return formatted;\n  }\n\n  /**\n   * Validate meeting infomation format.\n   * @param {Object} meeting\n   * @throws\n   */\n  _validate(meeting) {\n    if (!meeting) {\n      throw new MeetingErrors(meetingStatus.invalidMeetingInfo);\n    }\n    const {\n      topic,\n      password,\n      schedule,\n      _requireMeetingPassword,\n    } = meeting;\n    const errors = new MeetingErrors();\n    if (topic.length <= 0) {\n      errors.push(meetingStatus.emptyTopic);\n    }\n    if (_requireMeetingPassword && (!password || password.length <= 0)) {\n      errors.push(meetingStatus.noPassword);\n    }\n    if (schedule) {\n      if (schedule.durationInMinutes < 0) {\n        errors.push(meetingStatus.durationIncorrect);\n      }\n    }\n    if (errors.length > 0) {\n      throw errors;\n    }\n  }\n\n  get extensionInfo() {\n    return this._extensionInfo.info;\n  }\n\n  get meeting() {\n    return this.state.meeting;\n  }\n\n  get lastMeetingInfo() {\n    const state = this._storage.getItem(this._lastMeetingSettingKey);\n    return state;\n  }\n\n  get isScheduling() {\n    return this.state.schedulingStatus === scheduleStatus.scheduling;\n  }\n\n  get status() {\n    return this.state.status;\n  }\n}\n"]}